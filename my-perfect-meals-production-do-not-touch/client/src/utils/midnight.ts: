// utils/midnight.ts
export function scheduleLocalMidnightTick(cb: () => void) {
  function msUntilNextLocalMidnight() {
    const now = new Date();
    const next = new Date(now);
    next.setDate(now.getDate() + 1);
    next.setHours(0, 0, 0, 0);
    return next.getTime() - now.getTime();
  }
  let t = window.setTimeout(function tick() {
    cb(); // e.g., dispatch "macros:updated"
    t = window.setTimeout(tick, 24 * 60 * 60 * 1000);
  }, msUntilNextLocalMidnight());
  return () => clearTimeout(t);
}

/** Fire once on app start if the calendar day changed while app was closed. */
export function fireIfDayRolledOver(storageKey = "last-open-ymd") {
  const today = new Date();
  const ymd = `${today.getFullYear()}-${(today.getMonth()+1).toString().padStart(2,"0")}-${today.getDate().toString().padStart(2,"0")}`;
  const last = localStorage.getItem(storageKey);
  if (last && last !== ymd) {
    window.dispatchEvent(new Event("macros:updated"));
  }
  localStorage.setItem(storageKey, ymd);
}
