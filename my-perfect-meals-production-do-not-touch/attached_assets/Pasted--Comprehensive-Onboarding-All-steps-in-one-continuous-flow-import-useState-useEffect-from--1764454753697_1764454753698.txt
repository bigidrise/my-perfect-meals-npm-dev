// Comprehensive Onboarding - All steps in one continuous flow
import { useState, useEffect } from "react";
import { useLocation } from "wouter";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Checkbox } from "@/components/ui/checkbox";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Textarea } from "@/components/ui/textarea";
import { useToast } from "@/hooks/use-toast";
import { markJustFinished } from "@/lib/completion";
// import HormonalHealthAssessment from "@/components/hormonal-health-assessment";
// import { authApi } from "@/lib/api";
import { ChevronRight, ArrowLeft, ArrowRight, X } from "lucide-react";

// Removed weeklyPlanApi import - meal calendar functionality disabled
import { FoodSelector } from "@/components/FoodSelector";
import { Badge } from "@/components/ui/badge";
import { OnboardingFooter } from "@/components/OnboardingFooter";
import { useUpdatePreferences } from "@/hooks/useUserPreferences";
import { AutoSaveWrapper } from "@/components/onboarding/AutoSaveWrapper";
import { getDeviceId } from "@/utils/deviceId";
import { useStepProgress } from "@/hooks/useOnboardingProgress";
import { Save } from "lucide-react";
import HeightInput from "@/components/inputs/HeightInput";
// import { useAuth } from "@/hooks/useAuth";
type BodyType = "ecto" | "meso" | "endo";

const psychQuestions = [
  {
    field: "structureResponse",
    question: "How do you usually respond to structure?",
    options: [
      {
        value: "love_structure",
        label: "I love structureâ€”it helps me stay on track",
      },
      {
        value: "resist_structure",
        label: "I resist structureâ€”I prefer flexibility",
      },
      {
        value: "light_guidance",
        label: "I do best with light guidance, not strict rules",
      },
    ],
  },
  {
    field: "setbackResponse",
    question:
      "How do you respond to setbacks (e.g., overeating, skipping meals)?",
    options: [
      { value: "discouraged", label: "I feel discouraged and tend to give up" },
      { value: "bounce_back", label: "I bounce back quickly" },
      {
        value: "guilty_recover",
        label: "I feel guilty but try to recover the next day",
      },
    ],
  },
  {
    field: "primaryMotivation",
    question: "What motivates you the most?",
    options: [
      { value: "visible_results", label: "Visible results (like weight loss)" },
      {
        value: "feeling_better",
        label: "Feeling better physically and mentally",
      },
      { value: "support_praise", label: "Support and praise from others" },
      { value: "hitting_goals", label: "Hitting goals and checking off tasks" },
      {
        value: "avoiding_consequences",
        label: "Avoiding negative consequences (like health scares)",
      },
    ],
  },
  {
    field: "foodDecisionMaking",
    question: "How do you make food decisions?",
    options: [
      {
        value: "know_struggle",
        label: "I know what to do but struggle to follow through",
      },
      { value: "overwhelmed", label: "I'm overwhelmed by too many choices" },
      { value: "follow_plan", label: "I prefer to follow a set plan" },
      {
        value: "understand_why",
        label: "I want to understand why the food works for me",
      },
    ],
  },
  {
    field: "accountabilityPreference",
    question: "How do you like to be held accountable?",
    options: [
      { value: "encouragement", label: "Encouragement and gentle reminders" },
      { value: "firm_guidance", label: "Clear rules and firm guidance" },
      { value: "tracking_tools", label: "Tracking tools and visual progress" },
      { value: "self_reflection", label: "Quiet self-reflection" },
      { value: "community", label: "Community support or group challenges" },
    ],
  },
  {
    field: "foodRelationship",
    question: "What best describes your relationship with food?",
    options: [
      {
        value: "comfort_stress",
        label: "I use food for comfort or stress relief",
      },
      {
        value: "fuel_enjoy",
        label: "I eat for fuel but still enjoy good meals",
      },
      { value: "guilt_indulging", label: "I feel guilty after indulging" },
      { value: "skip_forget", label: "I often skip meals or forget to eat" },
    ],
  },
  {
    field: "longTermConfidence",
    question: "How confident do you feel in managing your nutrition long-term?",
    options: [
      { value: "very_confident", label: "Very confidentâ€”I just need a system" },
      {
        value: "somewhat_confident",
        label: "Somewhat confidentâ€”I need help sticking to it",
      },
      {
        value: "not_confident",
        label: "Not confidentâ€”I feel like nothing works for me",
      },
    ],
  },
  {
    field: "cravingAttitude",
    question: "How do you feel about cravings or indulgent foods?",
    options: [
      { value: "avoid_completely", label: "I try to avoid them completely" },
      {
        value: "include_without_guilt",
        label: "I want to include them without guilt",
      },
      {
        value: "need_guidance",
        label: "I need guidance on how to balance them",
      },
      {
        value: "give_in_guilt",
        label: "I often give in, then feel bad afterward",
      },
    ],
  },
  {
    field: "persistenceDriver",
    question: "When things get hard, what keeps you going?",
    options: [
      { value: "long_term_vision", label: "My long-term vision or goals" },
      { value: "accountability_others", label: "Accountability from others" },
      {
        value: "consistent_routines",
        label: "Consistent routines or structure",
      },
      { value: "hope_feel_better", label: "Hope that I'll feel better soon" },
      { value: "usually_give_up", label: "Honestly, I usually give up" },
    ],
  },
  {
    field: "learningStyle",
    question: "What best describes how you like to learn or follow a plan?",
    options: [
      {
        value: "show_tell_why",
        label: "Show me what to do and tell me why it works",
      },
      {
        value: "flexibility_no_rules",
        label: "Give me flexibilityâ€”I don't like being told what to do",
      },
      {
        value: "step_by_step",
        label: "Break it down step by stepâ€”I get overwhelmed",
      },
      { value: "create_plan", label: "Just create the planâ€”I'll follow it" },
      {
        value: "structure_explanation",
        label: "I need both structure and explanation",
      },
    ],
  },
];

interface ComprehensiveOnboardingData {
  // Step 1: Welcome & Name
  firstName: string;
  lastName: string;

  // Step 2: Basic Profile
  age: number;
  birthdayMonth: string;
  birthdayDay: string;
  gender: string;
  height: number;
  weight: number;
  activityLevel: string;
  bodyType: BodyType;

  // Step 3: Goals & Timeline
  primaryGoal: string;
  customGoal: string;
  goalTimeline: string;
  targetWeight?: number;
  weeklyWeightLoss?: number;

  // Step 4: Medical Conditions & Restrictions
  medicalConditions: string[];
  foodAllergies: string[];
  dietaryRestrictions: string[];
  customMedicalConditions: Record<string, string>;
  customAllergies: string[];
  customRestrictions: string[];
  customMedicalLabels: Record<string, string>;

  // Step 5: Accountability & Progress Tracking Preferences
  weighInFrequency: string;
  bodyMeasurements: boolean;
  bodyFatTracking: boolean;
  progressPhotos: boolean;
  accountabilityStyle: string;
  checkInFrequency: string;
  preferredCheckInTime: string;
  goalReviewFrequency: string;

  // Step 6: Psychological Profile
  psychologicalProfile: {
    structureResponse: string;
    setbackResponse: string;
    primaryMotivation: string;
    foodDecisionMaking: string;
    accountabilityPreference: string;
    foodRelationship: string;
    longTermConfidence: string;
    cravingAttitude: string;
    persistenceDriver: string;
    learningStyle: string;
  };

  // Step 7: Comprehensive Food Preferences
  preferredFruitsVegetables: string[];
  preferredProteins: string[];
  preferredCarbohydrates: string[];
  preferredFats: string[];
  preferredSweeteners: string[];
  customFruitsVegetables: string;
  customProteins: string;
  customCarbohydrates: string;
  customFats: string;
  customSweeteners: string;

  // Step 8: Women's Hormonal Evaluation
  womenHormonalSymptoms: string[];
  womenReproductiveHistory: string[];
  womenHormonalConditions: string[];
  womenAge: number;
  womenLastMenstrualCycle: string;
  womenCustomHormonalInfo: string;

  // Step 9: Men's Hormonal Evaluation
  menEnergyPerformance: string[];
  menTestosteroneAge: string[];
  menLifestyleHealth: string[];
  menAge: number;
  menCustomHormonalInfo: string;

  // Step 10: AI Voice & Journaling
  enableVoiceAssistant: boolean;
  enableJournaling: boolean;
  journalingMethod: string;
  dailyReminder: boolean;
  reminderTime: string;
  journalingFocusAreas: string[];
  emotionalCheckIns: boolean;
  moodTracking: boolean;

  // Step 11: Foods to Avoid (NEW STEP)
  avoidedFoods: string[];
  likedFoods: string[];
  avoidSweeteners: string[];

  // Step 12: Glycemic Preferences (NEW STEP)
  preferredLowGICarbs: string[];
  preferredMidGICarbs: string[];
  preferredHighGICarbs: string[];

  // Placeholder for skipped sections
  skippedHormonalAssessment?: boolean;
  hormonalStage?: string;
  menstrualCycle?: string;
  hormonalSymptoms?: string[];
  hormonalSupportPreferences?: string[];
  foodPreferences?: string[]; // Add this for consistency if it exists elsewhere

  // AI Voice & Journaling Preferences (new fields)
  aiVoicePreferences?: {
    enableVoiceAssistant?: boolean;
    enableVoiceReminders?: boolean;
    enableDailyCheckin?: boolean;
  };
  journalingPreferences?: {
    enableDailyJournaling?: boolean;
    enableMoodTracking?: boolean;
    enableGoalTracking?: boolean;
  };
}

const TOTAL_STEPS = 3; // 1=Name+Profile+Goal, 2=Medical, 3=Glycemic Preferences

export default function ComprehensiveOnboarding() {
  console.log("ðŸŽ¯ ComprehensiveOnboarding component mounted");
  const [currentStep, setCurrentStep] = useState(1); // Start from step 1
  const [, setLocation] = useLocation();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [showValidation, setShowValidation] = useState(false);
  const { toast } = useToast();
  const userId = "1"; // Default user ID for development
  const updatePreferences = useUpdatePreferences(userId);

  const [customFood, setCustomFood] = useState("");
  
  const [data, setData] = useState<ComprehensiveOnboardingData>({
    // Step 1: Welcome & Name
    firstName: "",
    lastName: "",

    // Step 2: Basic Profile
    age: 0,
    birthdayMonth: "",
    birthdayDay: "",
    gender: "",
    height: 0,
    weight: 0,
    activityLevel: "",
     bodyType: "meso",

    // Step 3: Goals & Timeline
    primaryGoal: "",
    customGoal: "",
    goalTimeline: "",
    targetWeight: undefined, // Use undefined for optional numbers
    weeklyWeightLoss: undefined,

    // Step 4: Medical Conditions & Restrictions
    medicalConditions: [],
    foodAllergies: [],
    dietaryRestrictions: [],
    customMedicalConditions: {}, // Initialize as an empty object
    customAllergies: [],
    customRestrictions: [],
    customMedicalLabels: {},

    // Step 5: Accountability & Progress Tracking Preferences
    weighInFrequency: "",
    bodyMeasurements: false,
    bodyFatTracking: false,
    progressPhotos: false,
    accountabilityStyle: "",
    checkInFrequency: "",
    preferredCheckInTime: "",
    goalReviewFrequency: "",

    // Step 6: Psychological Profile
    psychologicalProfile: {
      structureResponse: "",
      setbackResponse: "",
      primaryMotivation: "",
      foodDecisionMaking: "",
      accountabilityPreference: "",
      foodRelationship: "",
      longTermConfidence: "",
      cravingAttitude: "",
      persistenceDriver: "",
      learningStyle: "",
    },

    // Step 7: Comprehensive Food Preferences
    preferredFruitsVegetables: [],
    preferredProteins: [],
    preferredCarbohydrates: [],
    preferredFats: [],
    preferredSweeteners: [],
    customFruitsVegetables: "",
    customProteins: "",
    customCarbohydrates: "",
    customFats: "",
    customSweeteners: "",

    // Step 8: Women's Hormonal Evaluation
    womenHormonalSymptoms: [],
    womenReproductiveHistory: [],
    womenHormonalConditions: [],
    womenAge: 0,
    womenLastMenstrualCycle: "",
    womenCustomHormonalInfo: "",

    // Step 9: Men's Hormonal Evaluation
    menEnergyPerformance: [],
    menTestosteroneAge: [],
    menLifestyleHealth: [],
    menAge: 0,
    menCustomHormonalInfo: "",

    // Step 10: AI Voice & Journaling
    enableVoiceAssistant: true,
    enableJournaling: false,
    journalingMethod: "both",
    dailyReminder: true,
    reminderTime: "20:00",
    journalingFocusAreas: [],
    emotionalCheckIns: true,
    moodTracking: true,

    // Step 11: Foods to Avoid
    avoidedFoods: [],
    likedFoods: [],
    avoidSweeteners: [],

    // Step 12: Glycemic Preferences
    preferredLowGICarbs: [],
    preferredMidGICarbs: [],
    preferredHighGICarbs: [],

    // Added for completeness based on usage in handleSubmit
    skippedHormonalAssessment: false,
    hormonalStage: "not_applicable",
    menstrualCycle: "not_applicable",
    hormonalSymptoms: [],
    hormonalSupportPreferences: [],
    foodPreferences: [],

    // Initialize AI Voice & Journaling Preferences
    aiVoicePreferences: {
      enableVoiceAssistant: true,
      enableVoiceReminders: false,
      enableDailyCheckin: false,
    },
    journalingPreferences: {
      enableDailyJournaling: false,
      enableMoodTracking: false,
      enableGoalTracking: false,
    },
  });

  const scrollToTop = () => {
    // Try multiple scroll methods to ensure it works across different browsers/scenarios
    window.scrollTo({ top: 0, behavior: "instant" });
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;

    // Also handle any custom scrolling containers
    const appContainer = document.getElementById("appScroll");
    if (appContainer) {
      appContainer.scrollTop = 0;
    }
  };

  // Placeholder for handleFinalSubmit function
  const handleFinalSubmit = () => {
    console.log("ðŸŽ¯ Calling handleSubmit from handleNext");
    handleSubmit();
  };

  const handleNext = () => {
    console.log("ðŸŽ¯ handleNext called", {
      currentStep,
      TOTAL_STEPS,
      finalStep: TOTAL_STEPS + 4,
      shouldSubmit: currentStep >= TOTAL_STEPS + 4
    });

    // Check if current step is valid
    if (!isStepValid()) {
      setShowValidation(true);
      toast({
        title: "Missing Required Fields",
        description: "Please fill in all required fields highlighted in red.",
        variant: "destructive",
        duration: 5000,
      });
      // Scroll to top so user can see the red fields
      setTimeout(() => scrollToTop(), 0);
      return;
    }

    // Reset validation for next step
    setShowValidation(false);

    // Ensure we don't exceed the maximum step count
    const maxStep = TOTAL_STEPS; // 2 steps total

    if (currentStep >= maxStep) {
      handleFinalSubmit();
    } else if (currentStep < maxStep) {
      setCurrentStep((prev) => prev + 1);
      // Force scroll to top immediately
      setTimeout(() => scrollToTop(), 0);
    }
  };

  const handleBack = () => {
    if (currentStep > 1) {
      setCurrentStep(currentStep - 1);
      // Force scroll to top immediately
      setTimeout(() => scrollToTop(), 0);
    }
  };

  // Save current step data to backend using onboarding progress API
  const handleSave = async () => {
    setIsSaving(true);
    try {
      console.log("ðŸ”„ Saving onboarding step:", currentStep, "with data:", data);

      // Use the correct onboarding step API endpoint
      const deviceId = getDeviceId();
      const stepKey = `step-${currentStep}`;
      const response = await fetch(`/api/onboarding/step/${stepKey}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "X-Device-Id": deviceId,
        },
        body: JSON.stringify({
          userId: userId,
          data: {
            ...data,
            currentStep,
            lastSaved: new Date().toISOString(),
          },
          completed: false,
          apply: false,
        }),
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error("âŒ Save failed:", { status: response.status, errorText });
        throw new Error(
          `Save failed: ${response.status} ${response.statusText}`,
        );
      }

      const result = await response.json();
      console.log("âœ… Save successful:", result);

      toast({
        title: "Progress Saved",
        description: `Your step ${currentStep} data has been saved successfully.`,
      });
    } catch (error) {
      console.error("Save error:", error);
      toast({
        title: "Save Failed",
        description:
          error instanceof Error
            ? error.message
            : "Failed to save progress. Please try again.",
        variant: "destructive",
      });
    } finally {
      setIsSaving(false);
    }
  };

  // Load existing user profile data when page loads (for editing profile)
  useEffect(() => {
    const loadExistingProfile = async () => {
      try {
        const response = await fetch("/api/user/profile", {
          headers: {
            "X-Device-Id": getDeviceId(),
          },
        });
        
        if (response.ok) {
          const profile = await response.json();
          console.log("âœ… Loaded existing profile:", profile);
          
          // Pre-populate form with existing data
          setData((prev) => ({
            ...prev,
            firstName: profile.firstName || prev.firstName,
            lastName: profile.lastName || prev.lastName,
            age: profile.age || prev.age,
            gender: profile.gender || prev.gender,
            height: profile.height || prev.height,
            weight: profile.weight || prev.weight,
            activityLevel: profile.activityLevel || prev.activityLevel,
            bodyType: profile.bodyType || prev.bodyType,
            primaryGoal: profile.primaryGoal || prev.primaryGoal,
            customGoal: profile.customGoal || prev.customGoal,
            medicalConditions: profile.medicalConditions || prev.medicalConditions,
            foodAllergies: profile.foodAllergies || prev.foodAllergies,
            dietaryRestrictions: profile.dietaryRestrictions || prev.dietaryRestrictions,
            customMedicalConditions: profile.customMedicalConditions || prev.customMedicalConditions,
            customAllergies: profile.customAllergies || prev.customAllergies,
            customRestrictions: profile.customRestrictions || prev.customRestrictions,
          }));
        }
      } catch (error) {
        console.log("â„¹ï¸ No existing profile found or error loading:", error);
        // Don't show error to user - they might be creating a new profile
      }
    };

    loadExistingProfile();
  }, []); // Run once on mount

  // Scroll to top whenever the current step changes
  useEffect(() => {
    scrollToTop();
  }, [currentStep]);

  // Legacy save method (not used anymore but kept for reference)
  const handleSaveLegacy = async () => {
    setIsSaving(true);
    try {
      // Create payload with all current data
      const savePayload = {
        // Basic profile data
        age: data.age,
        gender: data.gender,
        height: data.height || 68, // Default 68 inches = 5'8"
        weight: data.weight,
        activityLevel: data.activityLevel,

        // Goals and timeline
        primaryGoal: data.primaryGoal,
        goalTimeline: data.goalTimeline,
        targetWeight: data.targetWeight,
        weeklyWeightLoss: data.weeklyWeightLoss,

        // Medical conditions and restrictions
        medicalConditions: data.medicalConditions,
        foodAllergies: data.foodAllergies,
        dietaryRestrictions: data.dietaryRestrictions,
        customMedicalConditions: data.customMedicalConditions,
        customAllergies: data.customAllergies,
        customRestrictions: data.customRestrictions,
        customMedicalLabels: data.customMedicalLabels,

        // Progress tracking preferences
        weighInFrequency: data.weighInFrequency,
        bodyMeasurements: data.bodyMeasurements,
        bodyFatTracking: data.bodyFatTracking,
        progressPhotos: data.progressPhotos,
        accountabilityStyle: data.accountabilityStyle,
        checkInFrequency: data.checkInFrequency,
        preferredCheckInTime: data.preferredCheckInTime,
        goalReviewFrequency: data.goalReviewFrequency,

        // Psychological profile
        psychologicalProfile: data.psychologicalProfile,

        // Food preferences
        preferredFruitsVegetables: data.preferredFruitsVegetables,
        preferredProteins: data.preferredProteins,
        preferredCarbohydrates: data.preferredCarbohydrates,
        preferredFats: data.preferredFats,
        customFruitsVegetables: data.customFruitsVegetables,
        customProteins: data.customProteins,
        customCarbohydrates: data.customCarbohydrates,
        customFats: data.customFats,

        // Hormonal assessment
        womenHormonalSymptoms: data.womenHormonalSymptoms,
        womenReproductiveHistory: data.womenReproductiveHistory,
        womenHormonalConditions: data.womenHormonalConditions,
        womenAge: data.womenAge,
        womenLastMenstrualCycle: data.womenLastMenstrualCycle,
        womenCustomHormonalInfo: data.womenCustomHormonalInfo,

        menEnergyPerformance: data.menEnergyPerformance,
        menTestosteroneAge: data.menTestosteroneAge,
        menLifestyleHealth: data.menLifestyleHealth,
        menAge: data.menAge,
        menCustomHormonalInfo: data.menCustomHormonalInfo,

        // Voice and journaling
        enableVoiceAssistant: data.enableVoiceAssistant,
        enableJournaling: data.enableJournaling,
        journalingMethod: data.journalingMethod,
        dailyReminder: data.dailyReminder,
        reminderTime: data.reminderTime,
        journalingFocusAreas: data.journalingFocusAreas,
        emotionalCheckIns: data.emotionalCheckIns,
        moodTracking: data.moodTracking,

        // Foods to avoid and liked foods
        avoidedFoods: data.avoidedFoods,
        likedFoods: data.likedFoods,

        // Additional metadata
        currentStep,
        lastSaved: new Date().toISOString(),
      };

      // Save to backend using the updatePreferences mutation
      await updatePreferences.mutateAsync(savePayload);

      toast({
        title: "Progress Saved",
        description: `Step ${currentStep} data has been saved successfully.`,
      });
    } catch (error: any) {
      toast({
        title: "Save Error",
        description:
          error.message || "Failed to save progress. Please try again.",
        variant: "destructive",
      });
    } finally {
      setIsSaving(false);
    }
  };

  const handleSaveAndNext = async () => {
    // Check if current step is valid before saving
    if (!isStepValid()) {
      setShowValidation(true);
      toast({
        title: "Missing Required Fields",
        description: "Please fill in all required fields highlighted in red.",
        variant: "destructive",
        duration: 5000,
      });
      // Scroll to top so user can see the red fields
      setTimeout(() => scrollToTop(), 0);
      return;
    }
    
    await handleSave();
    handleNext(); // Use the refined handleNext
    // Ensure scroll to top after save and navigation
    setTimeout(() => scrollToTop(), 100);
  };

  const handleSubmit = async () => {
    setIsSubmitting(true);
    try {
      // Complete onboarding with collected data (email/password already handled by Auth.tsx)
      const userData = {
        firstName: data.firstName,
        lastName: data.lastName,
        age: data.age || 25,
        gender: data.gender || "male",
        height: data.height || 68,
        weight: data.weight || 150,
        activityLevel: data.activityLevel || "moderate",
        bodyType: data.bodyType || "meso",
        primaryGoal: data.primaryGoal || "weight_loss",
        customGoal: data.customGoal || "",
        goalTimeline: data.goalTimeline || "3_months",
        targetWeight: data.targetWeight || 140,
        weeklyWeightLoss: data.weeklyWeightLoss || 1,
        medicalConditions: data.medicalConditions || [],
        foodAllergies: data.foodAllergies || [],
        dietaryRestrictions: data.dietaryRestrictions || [],
        customMedicalConditions: data.customMedicalConditions || {}, // Ensure it's an object
        customAllergies: data.customAllergies || [],
        customRestrictions: data.customRestrictions || [],
        customMedicalLabels: data.customMedicalLabels || {},
        weighInFrequency: data.weighInFrequency || "weekly",
        bodyMeasurements: data.bodyMeasurements || false,
        bodyFatTracking: data.bodyFatTracking || false,
        progressPhotos: data.progressPhotos || false,
        accountabilityStyle: data.accountabilityStyle || "self_directed",
        checkInFrequency: data.checkInFrequency || "weekly",
        preferredCheckInTime: data.preferredCheckInTime || "morning",
        goalReviewFrequency: data.goalReviewFrequency || "monthly",
        foodPreferences: data.foodPreferences || [],
        hormonalStage: data.hormonalStage || "not_applicable",
        menstrualCycle: data.menstrualCycle || "not_applicable",
        hormonalSymptoms: data.hormonalSymptoms || [],
        hormonalSupportPreferences: data.hormonalSupportPreferences || [],
        skippedHormonalAssessment: data.skippedHormonalAssessment || false,
        enableVoiceAssistant: data.enableVoiceAssistant || false,
        enableJournaling: data.enableJournaling || false,
        journalingMethod: data.journalingMethod || "text",
        dailyReminder: data.dailyReminder || false,
        reminderTime: data.reminderTime || "20:00",
        journalingFocusAreas: data.journalingFocusAreas || [],
        emotionalCheckIns: data.emotionalCheckIns || false,
        moodTracking: data.moodTracking || false,
        psychologicalProfile: data.psychologicalProfile || {
          structureResponse: "moderate",
          setbackResponse: "learn_and_adapt",
          primaryMotivation: "health_improvement",
          foodDecisionMaking: "analytical",
          accountabilityPreference: "self_directed",
          foodRelationship: "neutral",
          longTermConfidence: "confident",
          cravingAttitude: "moderate",
          persistenceDriver: "internal",
          learningStyle: "structure_explanation",
        },
        // Food preferences from Foods to Avoid step
        avoidedFoods: data.avoidedFoods || [],
        likedFoods: data.likedFoods || [],
        // Glycemic preferences from step 16
        preferredLowGICarbs: data.preferredLowGICarbs || [],
        preferredMidGICarbs: data.preferredMidGICarbs || [],
        preferredHighGICarbs: data.preferredHighGICarbs || [],
        // Include AI Voice & Journaling preferences
        aiVoicePreferences: data.aiVoicePreferences,
        journalingPreferences: data.journalingPreferences,
      };

      // await authApi.register(userData); // Placeholder for now

      // Mark onboarding as completed
      localStorage.setItem("completedProfile", "true");
      localStorage.setItem("completedIntro", "true");
      localStorage.setItem("onboardingCompleted", "true");
      localStorage.setItem("isAuthenticated", "true"); // Set auth flag for dashboard access

      // Show welcome message after setup
      toast({
        title: "Welcome to My Perfect Meals!",
        description: "Your personalized nutrition journey starts now. Choose your plan!",
      });

      // Navigate to pricing page for new accounts
      console.log("ðŸŽ¯ Navigating to pricing page after onboarding completion");
      markJustFinished(); // Bypass guards for 3 seconds
      sessionStorage.setItem("forceTop:/pricing", "1");
      setLocation("/pricing");
    } catch (error: any) {
      toast({
        title: "Setup Error",
        description:
          error.message || "Failed to complete setup. Please try again.",
        variant: "destructive",
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  const autoGenerateWeeklyPlan = async (userData: any) => {
    const userId = "1"; // Default user ID for development

    try {
      // 1) Check if a plan already exists, skip generation if so
      // Meal plan auto-generation disabled

      // 2) Generate fresh 7-day plan starting today
      const todayISO = new Date().toISOString().slice(0, 10);
      const endISO = new Date(Date.now() + 6 * 86400000)
        .toISOString()
        .slice(0, 10);

      // Sensible default meal structure for new users
      const mealStructure = {
        breakfasts: 1,
        lunches: 1,
        dinners: 1,
        snacks: 0,
      };

      // Build dietary preferences from onboarding data
      const dietaryInfo: any = {
        userId,
        bodyType: userData.bodyType || "meso",
        mealStructure,
        days: 7,
        generateImages: true,
        allowDuplicates: false,
      };

      // Add dietary restrictions from onboarding if present
      if (userData.dietaryRestrictions?.length) {
        dietaryInfo.tempDietPreference =
          userData.dietaryRestrictions.join(", ");
      }

      // Add medical conditions as override if present
      if (userData.medicalConditions?.length) {
        dietaryInfo.tempMedicalOverride = userData.medicalConditions.join(", ");
      }

      // Generate the plan
      const res = await fetch("/api/meal-engine/plan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(dietaryInfo),
      });

      if (!res.ok) {
        throw new Error("Failed to generate meal plan");
      }

      const planData = await res.json();

      // 3) Save the generated plan
      await fetch("/api/meal-plan/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          userId,
          plan: { meals: planData.meals },
          params: {
            mealStructure,
            days: 7,
            planStartDate: todayISO,
            planEndDate: endISO,
            tempDietPreference: dietaryInfo.tempDietPreference,
            tempMedicalOverride: dietaryInfo.tempMedicalOverride,
          },
        }),
      });

      console.log("âœ… Auto-generated 7-day meal plan for new user");
    } catch (error) {
      console.warn("Failed to auto-generate weekly plan:", error);
      // Don't block onboarding completion if plan generation fails
    }
  };

  const updateData = (updates: Partial<ComprehensiveOnboardingData>) => {
    setData((prev) => ({ ...prev, ...updates }));
  };

  const isStepValid = () => {
    switch (currentStep) {
      case 1: // Name + Basic Profile + Goal merged
        const hasGoal = data.primaryGoal === "custom" ? data.customGoal.trim() !== "" : data.primaryGoal !== "";
        return (
          data.firstName &&
          data.lastName &&
          data.age > 0 &&
          data.gender &&
          data.height > 0 &&
          data.weight > 0 &&
          data.activityLevel &&
          hasGoal
        );
      case 2: // Medical Conditions & Allergies
        return true; // Optional - allow proceeding even if nothing selected
      default:
        return true;
    }
  };

  // Main render logic
  const renderCurrentStep = () => {
    try {
      switch (currentStep) {
        case 1:
          return renderAccountCreation(); // Name + Basic Profile + Goal merged
        case 2:
          return renderMedicalConditions();
        case 3:
          return renderGlycemicPreferences(); // Low/Mid/High GI food preferences
        default:
          console.warn("ðŸš¨ Invalid step:", currentStep, "- defaulting to step 1");
          return renderAccountCreation(); // Default to the first step in this component
      }
    } catch (error) {
      console.error("ðŸš¨ Error rendering step:", currentStep, error);
      return (
        <Card className="w-full max-w-md mx-auto">
          <CardHeader className="bg-gradient-to-br from-red-600 via-black/600 to-black text-white rounded-t-lg">
            <CardTitle className="text-2xl font-bold">Step Error</CardTitle>
          </CardHeader>
          <CardContent className="p-8 text-center">
            <p className="text-black mb-6">
              There was an error loading this step. Please try refreshing or going back.
            </p>
            <Button
              onClick={() => setCurrentStep(Math.max(1, currentStep - 1))} // Ensure it doesn't go below the starting step
              className="bg-gradient-to-br from-neutral-600 via-black/600 to-black text-white px-8 py-3 text-lg"
            >
              Go Back
            </Button>
          </CardContent>
        </Card>
      );
    }
  };

  const renderAccountCreation = () => (
    <Card className="w-full max-w-md mx-auto bg-black/40 backdrop-blur-md border-white/15">
      <CardHeader className="bg-gradient-to-br from-neutral-600 via-black/600 to-black text-white rounded-t-lg">
        <CardTitle className="text-center">Welcome! Let's Get Started</CardTitle>
        <p className="text-sm text-white/80 text-center mt-2">
          Tell us about yourself so we can personalize your meal plans.
        </p>
      </CardHeader>
      <CardContent className="space-y-4 text-white pt-6">
        <div>
          <Label htmlFor="firstName" className={showValidation && !data.firstName ? "text-red-400" : ""}>
            First Name *
          </Label>
          <Input
            id="firstName"
            value={data.firstName}
            onChange={(e) => updateData({ firstName: e.target.value })}
            placeholder="Enter your first name"
            aria-required="true"
            aria-invalid={showValidation && !data.firstName}
            data-testid="input-first-name"
            className={`text-white ${showValidation && !data.firstName ? "border-red-500 border-2" : ""}`}
          />
        </div>
        <div>
          <Label htmlFor="lastName" className={showValidation && !data.lastName ? "text-red-400" : ""}>
            Last Name *
          </Label>
          <Input
            id="lastName"
            value={data.lastName}
            onChange={(e) => updateData({ lastName: e.target.value })}
            placeholder="Enter your last name"
            aria-required="true"
            aria-invalid={showValidation && !data.lastName}
            data-testid="input-last-name"
            className={`text-white ${showValidation && !data.lastName ? "border-red-500 border-2" : ""}`}
          />
        </div>
        <div>
          <Label htmlFor="age" className={showValidation && data.age === 0 ? "text-red-400" : ""}>
            Age *
          </Label>
          <Input
            id="age"
            type="number"
            value={data.age === 0 ? "" : data.age}
            onChange={(e) => {
              const age = parseInt(e.target.value);
              updateData({ age: isNaN(age) ? 0 : age });
            }}
            placeholder="Enter your age"
            aria-required="true"
            aria-invalid={showValidation && data.age === 0}
            className={`text-white ${showValidation && data.age === 0 ? "border-red-500 border-2" : ""}`}
          />
        </div>
        <div>
          <Label className={showValidation && (!data.birthdayMonth || !data.birthdayDay) ? "text-red-400" : ""}>
            Birthday (Month & Day) *
          </Label>
          <div className="flex gap-2">
            <Select
              value={data.birthdayMonth}
              onValueChange={(value) => updateData({ birthdayMonth: value })}
            >
              <SelectTrigger 
                className={`flex-1 ${showValidation && !data.birthdayMonth ? "border-red-500 border-2" : ""}`}
                data-testid="select-birthday-month"
              >
                <SelectValue placeholder="Month" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="01">January</SelectItem>
                <SelectItem value="02">February</SelectItem>
                <SelectItem value="03">March</SelectItem>
                <SelectItem value="04">April</SelectItem>
                <SelectItem value="05">May</SelectItem>
                <SelectItem value="06">June</SelectItem>
                <SelectItem value="07">July</SelectItem>
                <SelectItem value="08">August</SelectItem>
                <SelectItem value="09">September</SelectItem>
                <SelectItem value="10">October</SelectItem>
                <SelectItem value="11">November</SelectItem>
                <SelectItem value="12">December</SelectItem>
              </SelectContent>
            </Select>
            <Select
              value={data.birthdayDay}
              onValueChange={(value) => updateData({ birthdayDay: value })}
            >
              <SelectTrigger 
                className={`w-24 ${showValidation && !data.birthdayDay ? "border-red-500 border-2" : ""}`}
                data-testid="select-birthday-day"
              >
                <SelectValue placeholder="Day" />
              </SelectTrigger>
              <SelectContent>
                {Array.from({ length: 31 }, (_, i) => i + 1).map((day) => (
                  <SelectItem key={day} value={day.toString().padStart(2, '0')}>
                    {day}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
          <p className="text-xs text-white/60 mt-1">We'll wish you happy birthday!</p>
        </div>
        <div>
          <Label htmlFor="gender" className={showValidation && !data.gender ? "text-red-400" : ""}>
            Gender *
          </Label>
          <Select
            value={data.gender}
            onValueChange={(value) => updateData({ gender: value })}
          >
            <SelectTrigger 
              aria-required="true" 
              aria-invalid={showValidation && !data.gender}
              className={showValidation && !data.gender ? "border-red-500 border-2" : ""}
            >
              <SelectValue placeholder="Select gender" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="male">Male</SelectItem>
              <SelectItem value="female">Female</SelectItem>
              <SelectItem value="other">Other</SelectItem>
            </SelectContent>
          </Select>
        </div>
        <div>
          <HeightInput
            valueInches={data.height}
            onChange={(inches) => updateData({ height: inches })}
            allowMetricToggle={true}
            label="Height"
          />
        </div>
        <div>
          <Label htmlFor="weight" className={showValidation && data.weight === 0 ? "text-red-400" : ""}>
            Weight (lbs) *
          </Label>
          <Input
            id="weight"
            type="number"
            value={data.weight === 0 ? "" : data.weight}
            onChange={(e) => {
              const weight = parseInt(e.target.value);
              updateData({ weight: isNaN(weight) ? 0 : weight });
            }}
            placeholder="Enter your weight"
            aria-required="true"
            aria-invalid={showValidation && data.weight === 0}
            className={`text-white ${showValidation && data.weight === 0 ? "border-red-500 border-2" : ""}`}
          />
        </div>
        <div>
          <Label htmlFor="activityLevel" className={showValidation && !data.activityLevel ? "text-red-400" : ""}>
            Activity Level *
          </Label>
          <Select
            value={data.activityLevel}
            onValueChange={(value) => updateData({ activityLevel: value })}
          >
            <SelectTrigger
              aria-required="true"
              aria-invalid={showValidation && !data.activityLevel}
              className={showValidation && !data.activityLevel ? "border-red-500 border-2" : ""}
            >
              <SelectValue placeholder="Select activity level" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="sedentary">
                Sedentary (desk job, little exercise)
              </SelectItem>
              <SelectItem value="lightly_active">
                Lightly Active (light exercise 1-3 days/week)
              </SelectItem>
              <SelectItem value="moderately_active">
                Moderately Active (moderate exercise 3-5 days/week)
              </SelectItem>
              <SelectItem value="very_active">
                Very Active (hard exercise 6-7 days/week)
              </SelectItem>
              <SelectItem value="extremely_active">
                Extremely Active (very hard exercise, physical job)
              </SelectItem>
            </SelectContent>
          </Select>
        </div>

        {/* Primary Goal */}
        <div>
          <Label htmlFor="primaryGoal" className={showValidation && !data.primaryGoal ? "text-red-400" : ""}>
            Primary Goal *
          </Label>
          <Select
            value={data.primaryGoal}
            onValueChange={(value) => {
              updateData({ primaryGoal: value });
              if (value !== "custom") {
                updateData({ customGoal: "" });
              }
            }}
          >
            <SelectTrigger
              aria-required="true"
              aria-invalid={showValidation && !data.primaryGoal}
              className={showValidation && !data.primaryGoal ? "border-red-500 border-2" : ""}
            >
              <SelectValue placeholder="Select your primary goal" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="weight_loss">Weight Loss</SelectItem>
              <SelectItem value="muscle_gain">Muscle Gain</SelectItem>
              <SelectItem value="maintenance">Maintenance</SelectItem>
              <SelectItem value="health_improvement">Health Improvement</SelectItem>
              <SelectItem value="energy_boost">Energy Boost</SelectItem>
              <SelectItem value="custom">Other (Custom Goal)</SelectItem>
            </SelectContent>
          </Select>
        </div>

        {/* Custom Goal Input - Only shown if "custom" is selected */}
        {data.primaryGoal === "custom" && (
          <div>
            <Label htmlFor="customGoal" className={showValidation && !data.customGoal.trim() ? "text-red-400" : ""}>
              Your Custom Goal *
            </Label>
            <Input
              id="customGoal"
              value={data.customGoal}
              onChange={(e) => updateData({ customGoal: e.target.value })}
              placeholder="e.g., Improve athletic performance, Better sleep, etc."
              aria-required="true"
              aria-invalid={showValidation && !data.customGoal.trim()}
              className={`text-white ${showValidation && !data.customGoal.trim() ? "border-red-500 border-2" : ""}`}
            />
          </div>
        )}
      </CardContent>
    </Card>
  );

  const renderEducationalContent = (contentKey: string) => {
    // Educational content will be added later
    const content = {
      title: "Educational Content",
      subtitle: "Coming Soon",
      content: ["Educational content will be available here."],
    };
    return (
      <div className="max-w-4xl mx-auto">
        <div className="bg-white/80 backdrop-blur-sm rounded-xl shadow-2xl p-8 border border-indigo-200/50">
          <div className="text-center mb-8">
            <h1 className="text-4xl font-bold text-indigo-800 mb-4">
              {content.title}
            </h1>
            <p className="text-xl text-indigo-700">{content.subtitle}</p>
          </div>

          <div className="space-y-6 text-gray-800">
            {content.content.map((paragraph, index) => (
              <p key={index} className="text-lg leading-relaxed">
                {paragraph}
              </p>
            ))}
          </div>
        </div>
      </div>
    );
  };

  const renderBasicProfile = () => (
    <Card className="w-full max-w-md mx-auto bg-black/40 backdrop-blur-md border-white/15">
      <CardHeader className="bg-gradient-to-br from-neutral-600 via-black/600 to-black text-white rounded-t-lg">
        <CardTitle className="text-center">Basic Profile</CardTitle>
      </CardHeader>
      <CardContent className="space-y-4 text-white">
        <div>
          <Label htmlFor="age">Age</Label>
          <Input
            id="age"
            type="number"
            value={data.age === 0 ? "" : data.age} // Display empty if 0 for better UX
            onChange={(e) => {
              const age = parseInt(e.target.value);
              updateData({ age: isNaN(age) ? 0 : age });
            }}
            placeholder="Enter your age"
            aria-required="true"
            aria-invalid={data.age === 0}
            className="text-white"
          />
        </div>
        <div>
          <Label htmlFor="gender">Gender</Label>
          <Select
            value={data.gender}
            onValueChange={(value) => updateData({ gender: value })}
          >
            <SelectTrigger aria-required="true" aria-invalid={!data.gender}>
              <SelectValue placeholder="Select gender" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="male">Male</SelectItem>
              <SelectItem value="female">Female</SelectItem>
              <SelectItem value="other">Other</SelectItem>
            </SelectContent>
          </Select>
        </div>
        <div>
          <HeightInput
            valueInches={data.height}
            onChange={(inches) => updateData({ height: inches })}
            allowMetricToggle={true}
            label="Height"
          />
        </div>
        <div>
          <Label htmlFor="weight">Weight (lbs)</Label>
          <Input
            id="weight"
            type="number"
            value={data.weight === 0 ? "" : data.weight} // Display empty if 0 for better UX
            onChange={(e) => {
              const weight = parseInt(e.target.value);
              updateData({ weight: isNaN(weight) ? 0 : weight });
            }}
            placeholder="Enter your weight"
            aria-required="true"
            aria-invalid={data.weight === 0}
            className="text-white"
          />
        </div>
        <div>
          <Label htmlFor="activityLevel">Activity Level</Label>
          <Select
            value={data.activityLevel}
            onValueChange={(value) => updateData({ activityLevel: value })}
          >
            <SelectTrigger
              aria-required="true"
              aria-invalid={!data.activityLevel}
            >
              <SelectValue placeholder="Select activity level" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="sedentary">
                Sedentary (desk job, little exercise)
              </SelectItem>
              <SelectItem value="lightly_active">
                Lightly Active (light exercise 1-3 days/week)
              </SelectItem>
              <SelectItem value="moderately_active">
                Moderately Active (moderate exercise 3-5 days/week)
              </SelectItem>
              <SelectItem value="very_active">
                Very Active (hard exercise 6-7 days/week)
              </SelectItem>
              <SelectItem value="extremely_active">
                Extremely Active (very hard exercise, physical job)
              </SelectItem>
            </SelectContent>
          </Select>
        </div>
      </CardContent>
    </Card>
  );

  // Body Type
  // This div is outside of any function, causing it to be rendered directly in the component body.
  // It should be wrapped in a return statement or rendered within a specific JSX block.
  // Assuming it's intended to be part of the Basic Profile section or a separate rendering block:
  const renderBodyType = () => (
    <div className="mt-6">
      <Label className="block text-base font-semibold mb-2">Body Type</Label>
      <p className="text-sm text-white/80 mb-3">
        This tunes your carb/fat balance: <span className="font-medium">Ectomorph â†’ more starch tolerant</span>, <span className="font-medium">Mesomorph â†’ baseline</span>, <span className="font-medium">Endomorph â†’ fewer starches</span>.
      </p>
      <RadioGroup
        value={data.bodyType}
        onValueChange={(v: BodyType) => updateData({ bodyType: v })}
        className="grid grid-cols-1 sm:grid-cols-3 gap-3"
      >
        {[
          { v: "ecto" as BodyType, title: "Ectomorph", sub: "Handles carbs well", badge: "Carbs â†‘", bg: "bg-emerald-600", ring: "ring-emerald-300" },
          { v: "meso" as BodyType, title: "Mesomorph", sub: "Balanced baseline", badge: "Balanced", bg: "bg-indigo-600", ring: "ring-indigo-300" },
          { v: "endo" as BodyType, title: "Endomorph", sub: "Fewer starches work best", badge: "Starch â†“", bg: "bg-rose-600", ring: "ring-rose-300" },
        ].map((opt) => (
          <div key={opt.v} className="relative">
            <RadioGroupItem id={`bt-${opt.v}`} value={opt.v} className="peer sr-only" />
            <Label
              htmlFor={`bt-${opt.v}`}
              className={[
                "block cursor-pointer rounded-xl border-2 p-4 transition-all",
                "text-white shadow-[0_8px_24px_rgba(0,0,0,0.35)]",
                data.bodyType === opt.v
                  ? `border-white/80 bg-white/15 ring-2 ${opt.ring}`
                  : "border-white/20 hover:border-white/50 hover:bg-white/10",
              ].join(" ")}
            >
              <div className="flex items-center justify-between">
                <div className="font-semibold text-lg">{opt.title}</div>
                <span className={`text-xs px-2 py-0.5 rounded-full ${opt.bg} text-white font-semibold`}>
                  {opt.badge}
                </span>
              </div>
              <div className="text-sm text-white/80 mt-1">{opt.sub}</div>
            </Label>
          </div>
        ))}
      </RadioGroup>
    </div>
  );


  const renderGoalsTimeline = () => (
    <Card className="w-full max-w-md mx-auto bg-black/40 backdrop-blur-md border-white/15">
      <CardHeader className="bg-gradient-to-br from-neutral-600 via-black/600 to-black text-white rounded-t-lg">
        <CardTitle className="text-center">Your Goal</CardTitle>
      </CardHeader>
      <CardContent className="space-y-4 text-white">
        <div>
          <Label htmlFor="primaryGoal">Primary Goal</Label>
          <Select
            value={data.primaryGoal}
            onValueChange={(value) => updateData({ primaryGoal: value })}
          >
            <SelectTrigger
              aria-required="true"
              aria-invalid={!data.primaryGoal}
            >
              <SelectValue placeholder="Select your primary goal" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="weight_loss">Weight Loss</SelectItem>
              <SelectItem value="muscle_gain">Muscle Gain</SelectItem>
              <SelectItem value="maintenance">Maintenance</SelectItem>
              <SelectItem value="health_improvement">
                Health Improvement
              </SelectItem>
              <SelectItem value="energy_boost">Energy Boost</SelectItem>
            </SelectContent>
          </Select>
        </div>
      </CardContent>
    </Card>
  );

  const renderMedicalConditions = () => {
    const medicalConditions = [
      // Metabolic Conditions
      {
        id: "diabetes-type1",
        label: "Type 1 Diabetes",
        category: "metabolic",
        color: "bg-red-100 text-red-800",
      },
      {
        id: "diabetes-type2",
        label: "Type 2 Diabetes",
        category: "metabolic",
        color: "bg-red-100 text-red-800",
      },
      {
        id: "pre-diabetes",
        label: "Pre-Diabetes",
        category: "metabolic",
        color: "bg-red-100 text-red-800",
      },
      {
        id: "hypothyroid",
        label: "Hypothyroidism",
        category: "metabolic",
        color: "bg-red-100 text-red-800",
      },
      {
        id: "hyperthyroid",
        label: "Hyperthyroidism",
        category: "metabolic",
        color: "bg-red-100 text-red-800",
      },
      {
        id: "hashimotos",
        label: "Hashimoto's Thyroiditis",
        category: "metabolic",
        color: "bg-red-100 text-red-800",
      },
      {
        id: "graves-disease",
        label: "Graves' Disease",
        category: "metabolic",
        color: "bg-red-100 text-red-800",
      },
      {
        id: "insulin-resistance",
        label: "Insulin Resistance",
        category: "metabolic",
        color: "bg-red-100 text-red-800",
      },

      // Digestive & Autoimmune Conditions
      {
        id: "crohns",
        label: "Crohn's Disease",
        category: "digestive",
        color: "bg-orange-100 text-orange-800",
      },
      {
        id: "ulcerative-colitis",
        label: "Ulcerative Colitis",
        category: "digestive",
        color: "bg-orange-100 text-orange-800",
      },
      {
        id: "celiac",
        label: "Celiac Disease",
        category: "digestive",
        color: "bg-orange-100 text-orange-800",
      },
      {
        id: "ibs",
        label: "IBS",
        category: "digestive",
        color: "bg-orange-100 text-orange-800",
      },
      {
        id: "rheumatoid-arthritis",
        label: "Rheumatoid Arthritis",
        category: "digestive",
        color: "bg-orange-100 text-orange-800",
      },
      {
        id: "lupus",
        label: "Lupus",
        category: "digestive",
        color: "bg-orange-100 text-orange-800",
      },
      {
        id: "inflammatory-bowel",
        label: "Inflammatory Bowel Disease",
        category: "digestive",
        color: "bg-orange-100 text-orange-800",
      },
      {
        id: "gerd",
        label: "GERD",
        category: "digestive",
        color: "bg-orange-100 text-orange-800",
      },
      {
        id: "gastroparesis",
        label: "Gastroparesis",
        category: "digestive",
        color: "bg-orange-100 text-orange-800",
      },
      {
        id: "diverticulitis",
        label: "Diverticulitis",
        category: "digestive",
        color: "bg-orange-100 text-orange-800",
      },

      // Cardiovascular & Kidney Conditions
      {
        id: "hypertension",
        label: "High Blood Pressure",
        category: "cardiovascular",
        color: "bg-purple-100 text-purple-800",
      },
      {
        id: "heart-disease",
        label: "Heart Disease",
        category: "cardiovascular",
        color: "bg-purple-100 text-purple-800",
      },
      {
        id: "high-cholesterol",
        label: "High Cholesterol",
        category: "cardiovascular",
        color: "bg-purple-100 text-purple-800",
      },
      {
        id: "kidney-disease",
        label: "Chronic Kidney Disease",
        category: "cardiovascular",
        color: "bg-purple-100 text-purple-800",
      },
      {
        id: "kidney-stones",
        label: "Kidney Stones",
        category: "cardiovascular",
        color: "bg-purple-100 text-purple-800",
      },
      {
        id: "heart-failure",
        label: "Congestive Heart Failure",
        category: "cardiovascular",
        color: "bg-purple-100 text-purple-800",
      },
      {
        id: "coronary-artery",
        label: "Coronary Artery Disease",
        category: "cardiovascular",
        color: "bg-purple-100 text-purple-800",
      },
      {
        id: "stroke-history",
        label: "Stroke History",
        category: "cardiovascular",
        color: "bg-purple-100 text-purple-800",
      },

      // Respiratory & Inflammatory Conditions
      {
        id: "copd",
        label: "COPD",
        category: "respiratory",
        color: "bg-blue-100 text-blue-800",
      },
      {
        id: "arthritis",
        label: "Arthritis",
        category: "respiratory",
        color: "bg-blue-100 text-blue-800",
      },

      // GLP-1 Medications
      {
        id: "ozempic-semaglutide",
        label: "Ozempic/Semaglutide",
        category: "medications",
        color: "bg-green-100 text-green-800",
      },
      {
        id: "wegovy",
        label: "Wegovy",
        category: "medications",
        color: "bg-green-100 text-green-800",
      },
      {
        id: "mounjaro-tirzepatide",
        label: "Mounjaro/Tirzepatide",
        category: "medications",
        color: "bg-green-100 text-green-800",
      },
      {
        id: "trulicity",
        label: "Trulicity",
        category: "medications",
        color: "bg-green-100 text-green-800",
      },
      {
        id: "byetta",
        label: "Byetta",
        category: "medications",
        color: "bg-green-100 text-green-800",
      },
      {
        id: "victoza",
        label: "Victoza",
        category: "medications",
        color: "bg-green-100 text-green-800",
      },

      // Critical Food Allergies
      {
        id: "shellfish-allergy",
        label: "Shellfish",
        category: "allergies",
        color: "bg-red-100 text-red-800",
      },
      {
        id: "tree-nuts",
        label: "Tree Nuts",
        category: "allergies",
        color: "bg-red-100 text-red-800",
      },
      {
        id: "peanuts",
        label: "Peanuts",
        category: "allergies",
        color: "bg-red-100 text-red-800",
      },
      {
        id: "eggs",
        label: "Eggs",
        category: "allergies",
        color: "bg-red-100 text-red-800",
      },
      {
        id: "dairy-milk",
        label: "Dairy/Milk",
        category: "allergies",
        color: "bg-red-100 text-red-800",
      },
      {
        id: "soy",
        label: "Soy",
        category: "allergies",
        color: "bg-red-100 text-red-800",
      },
      {
        id: "wheat-gluten",
        label: "Wheat/Gluten",
        category: "allergies",
        color: "bg-red-100 text-red-800",
      },
      {
        id: "fish",
        label: "Fish",
        category: "allergies",
        color: "bg-red-100 text-red-800",
      },
      {
        id: "sesame",
        label: "Sesame",
        category: "allergies",
        color: "bg-red-100 text-red-800",
      },
      {
        id: "coconut",
        label: "Coconut",
        category: "allergies",
        color: "bg-red-100 text-red-800",
      },
      {
        id: "sulfites",
        label: "Sulfites",
        category: "allergies",
        color: "bg-red-100 text-red-800",
      },
    ];

    const categoryLabels: Record<string, string> = {
      metabolic: "Metabolic Conditions",
      digestive: "Digestive & Autoimmune",
      cardiovascular: "Cardiovascular & Kidney",
      respiratory: "Respiratory & Inflammatory",
      medications: "GLP-1 Medications",
      allergies: "Critical Food Allergies",
    };

    const groupedConditions = medicalConditions.reduce(
      (acc, condition) => {
        if (!acc[condition.category]) {
          acc[condition.category] = [];
        }
        acc[condition.category].push(condition);
        return acc;
      },
      {} as Record<string, typeof medicalConditions>,
    );

    return (
      <Card className="w-full max-w-4xl mx-auto bg-black/40 backdrop-blur-md border-white/15">
        <CardHeader className="bg-gradient-to-br from-neutral-600 via-black/600 to-black text-white rounded-t-lg">
          <CardTitle className="text-2xl font-bold flex items-center gap-3">
            <span className="text-3xl">ðŸ¥</span>
            Medical Conditions & Dietary Restrictions
          </CardTitle>
          <p className="text-white/90 mt-2">
            Please select any medical conditions, allergies, or dietary
            restrictions that apply to you. This information helps us create
            safer, more appropriate meal plans.
          </p>
        </CardHeader>
        <CardContent className="p-8 space-y-8">
          {Object.entries(groupedConditions).map(([category, conditions]) => (
            <div key={category} className="space-y-4">
              <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                <span className="text-2xl">
                  {category === "metabolic"
                    ? "âš¡"
                    : category === "digestive"
                      ? "ðŸ”„"
                      : category === "cardiovascular"
                        ? "ðŸ’“"
                        : category === "respiratory"
                          ? "ðŸ«"
                          : category === "medications"
                            ? "ðŸ’Š"
                            : "âš ï¸"}
                </span>
                {categoryLabels[category] || category}
              </h3>

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                {conditions.map((condition) => (
                  <button
                    key={condition.id}
                    onClick={() => {
                      const currentConditions = data.medicalConditions || [];
                      const isSelected = currentConditions.includes(
                        condition.id,
                      );

                      const newConditions = isSelected
                        ? currentConditions.filter((c) => c !== condition.id)
                        : [...currentConditions, condition.id];

                      // Use setData directly to ensure the state update is applied immediately
                      setData((prev) => ({
                        ...prev,
                        medicalConditions: newConditions,
                      }));
                    }}
                    className={`p-3 rounded-lg border-2 transition-all duration-200 text-left hover:shadow-md ${
                      (data.medicalConditions || []).includes(condition.id)
                        ? "border-blue-400 bg-blue-900/50 text-white shadow-md"
                        : "border-white/20 bg-black/30 text-white hover:border-blue-400/50"
                    }`}
                  >
                    <div className="flex items-center justify-between">
                      <span className="font-medium">{condition.label}</span>
                      {(data.medicalConditions || []).includes(
                        condition.id,
                      ) && <span className="text-blue-400 text-lg">âœ“</span>}
                    </div>
                  </button>
                ))}
              </div>

              {/* Custom condition input for this category */}
              <div className="mt-4 p-4 bg-black/20 rounded-lg border border-white/10">
                <Label className="text-sm font-medium text-white mb-2 block">
                  Add custom{" "}
                  {(categoryLabels[category] || category).toLowerCase()}{" "}
                  condition:
                </Label>
                <div className="flex gap-2">
                  <Input
                    placeholder={`Enter custom ${(categoryLabels[category] || category).toLowerCase()} condition`}
                    value={data.customMedicalConditions?.[category] || ""}
                    onChange={(e) => {
                      updateData({
                        customMedicalConditions: {
                          ...data.customMedicalConditions,
                          [category]: e.target.value,
                        },
                      });
                    }}
                    className="flex-1 text-white"
                  />
                  <Button
                    type="button"
                    size="sm"
                    onClick={() => {
                      const customCondition =
                        data.customMedicalConditions?.[category];
                      if (customCondition && customCondition.trim()) {
                        const customId = `custom-${category}-${Date.now()}`;
                        const currentConditions = data.medicalConditions || [];

                        updateData({
                          medicalConditions: [...currentConditions, customId],
                          customMedicalConditions: {
                            ...data.customMedicalConditions,
                            [category]: "",
                          },
                          customMedicalLabels: {
                            ...data.customMedicalLabels,
                            [customId]: customCondition.trim(),
                          },
                        });
                      }
                    }}
                    disabled={!data.customMedicalConditions?.[category]?.trim()}
                  >
                    Add
                  </Button>
                </div>
              </div>

              {/* Display added custom conditions */}
              {data.customMedicalLabels &&
                Object.entries(data.customMedicalLabels).some(
                  ([id, label]) =>
                    id.startsWith(`custom-${category}-`) &&
                    (data.medicalConditions || []).includes(id),
                ) && (
                  <div className="mt-3">
                    <Label className="text-sm font-medium text-white mb-2 block">
                      Added custom conditions:
                    </Label>
                    <div className="flex flex-wrap gap-2">
                      {Object.entries(data.customMedicalLabels).map(
                        ([id, label]) => {
                          if (
                            id.startsWith(`custom-${category}-`) &&
                            (data.medicalConditions || []).includes(id)
                          ) {
                            return (
                              <div
                                key={id}
                                className="flex items-center gap-2 bg-blue-900/50 text-white px-3 py-1 rounded-full text-sm border border-blue-400"
                              >
                                <span>{label}</span>
                                <button
                                  onClick={() => {
                                    const currentConditions =
                                      data.medicalConditions || [];
                                    const newCustomLabels = {
                                      ...data.customMedicalLabels,
                                    };
                                    delete newCustomLabels[id];

                                    updateData({
                                      medicalConditions:
                                        currentConditions.filter(
                                          (c) => c !== id,
                                        ),
                                      customMedicalLabels: newCustomLabels,
                                    });
                                  }}
                                  className="text-blue-300 hover:text-white"
                                >
                                  Ã—
                                </button>
                              </div>
                            );
                          }
                          return null;
                        },
                      )}
                    </div>
                  </div>
                )}
            </div>
          ))}

          <div className="bg-white/10 backdrop-blur-sm p-6 rounded-lg">
            <h3 className="font-semibold text-white mb-2">
              Medical Safety Note
            </h3>
            <p className="text-white/90">
              For diabetes users: We provide exact carb counts for insulin
              dosing calculations. For allergy users: We completely avoid all
              selected allergens in meal planning. This information is used to
              create medically appropriate meal plans.
            </p>
          </div>
        </CardContent>
      </Card>
    );
  };

  // Data constants from the requirements
  const foodOptions = {
    fruitsVegetables: [
      "Apples",
      "Bananas",
      "Blueberries",
      "Strawberries",
      "Oranges",
      "Grapes",
      "Avocados",
      "Tomatoes",
      "Spinach",
      "Kale",
      "Zucchini",
      "Bell Peppers",
      "Broccoli",
      "Cauliflower",
      "Carrots",
      "Cucumber",
      "Mango",
      "Pineapple",
      "Green Beans",
      "Sweet Potatoes",
    ],
    proteins: [
      "Chicken Breast",
      "Ground Turkey",
      "Eggs",
      "Greek Yogurt",
      "Salmon",
      "Tilapia",
      "Tofu",
      "Tempeh",
      "Shrimp",
      "Beef (Lean)",
      "Pork Tenderloin",
      "Lamb",
      "Venison",
      "Cottage Cheese",
      "Protein Powder (Whey)",
      "Protein Powder (Plant-Based)",
      "Tuna",
      "Sardines",
      "Lentils",
      "Black Beans",
    ],
    carbohydrates: [
      "Brown Rice",
      "Quinoa",
      "Oats",
      "Whole Wheat Bread",
      "Sweet Potatoes",
      "White Potatoes",
      "Corn",
      "Peas",
      "Beans (Kidney, Pinto)",
      "Couscous",
      "Barley",
      "Farro",
      "Whole Wheat Pasta",
      "Rice Cakes",
      "Tortillas (Whole Grain)",
      "Plantains",
      "Banana",
      "Bulgur",
      "Amaranth",
      "Millet",
    ],
    fats: [
      "Avocado",
      "Olive Oil",
      "Coconut Oil",
      "Almonds",
      "Walnuts",
      "Chia Seeds",
      "Flaxseeds",
      "Sunflower Seeds",
      "Peanut Butter",
      "Almond Butter",
      "Tahini",
      "Cheese",
      "Egg Yolks",
      "Dark Chocolate (85%)",
      "Cashews",
      "Pistachios",
      "Pecans",
      "Ghee",
      "Sesame Oil",
      "Macadamia Nuts",
    ],
    sweeteners: [
      "Sugar",
      "Brown Sugar",
      "Honey",
      "Maple Syrup",
      "Stevia",
      "Monk Fruit",
      "Erythritol",
      "Xylitol",
      "Agave",
      "Coconut Sugar",
      "Date Syrup",
      "Rice Syrup",
      "Molasses",
      "Splenda",
      "Equal",
      "Sweet N Low",
    ],
  };

  const handleArrayToggle = (
    field: keyof ComprehensiveOnboardingData,
    item: string,
  ) => {
    const currentArray = data[field] as string[];
    const newArray = currentArray.includes(item)
      ? currentArray.filter((i) => i !== item)
      : [...currentArray, item];
    updateData({ [field]: newArray });
  };

  const handleInputChange = (
    field: keyof ComprehensiveOnboardingData,
    value: string,
  ) => {
    updateData({ [field]: value });
  };

  const renderCheckboxSection = (
    title: string,
    field: keyof ComprehensiveOnboardingData,
    options: string[],
    customField?: keyof ComprehensiveOnboardingData,
    placeholder?: string,
    showSaveButton?: boolean,
  ) => {
    const currentSelections = data[field] as string[];
    const allSelected = options.every((option) =>
      currentSelections.includes(option),
    );

    const handleSelectAll = () => {
      if (allSelected) {
        // Deselect all
        setData((prev) => ({
          ...prev,
          [field]: [],
        }));
      } else {
        // Select all
        setData((prev) => ({
          ...prev,
          [field]: [...options],
        }));
      }
    };

    return (
      <div className="space-y-3">
        <div className="flex items-center justify-between">
          <h4 className="font-semibold text-lg text-white">{title}</h4>
          <Button
            type="button"
            variant="outline"
            size="sm"
            onClick={handleSelectAll}
            className="h-8 px-3 text-xs bg-white/20 hover:bg-white/30 border-white/30 text-white"
          >
            {allSelected ? "Deselect All" : "Select All"}
          </Button>
        </div>
        <div className="grid grid-cols-2 gap-3">
          {options.map((option) => (
            <div key={option} className="flex items-center space-x-2">
              <input
                type="checkbox"
                id={`${field}-${option}`}
                checked={(data[field] as string[]).includes(option)}
                onChange={() => handleArrayToggle(field, option)}
                className="h-4 w-4 rounded border-white/30"
              />
              <label
                htmlFor={`${field}-${option}`}
                className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 text-white"
              >
                {option}
              </label>
            </div>
          ))}
        </div>
        {customField && (
          <div className="mt-4">
            <label className="block text-sm font-medium text-white mb-2">
              Add items not listed above (separate with commas):
            </label>
            <Input
              placeholder={placeholder || "ex: Add custom items here"}
              value={data[customField] as string}
              onChange={(e) => handleInputChange(customField, e.target.value)}
              className="w-full text-white"
            />
          </div>
        )}
        {showSaveButton && (
          <div className="mt-4">
            <Button
              type="button"
              onClick={handleSaveProgress}
              disabled={saveStep.isPending}
              className="w-full bg-red-600 hover:bg-red-700 text-white backdrop-blur-md flex items-center justify-center"
              data-testid={`button-save-${field}`}
            >
              {saveStep.isPending ? "Saving..." : "Save"}
            </Button>
          </div>
        )}
      </div>
    );
  };

  const renderFoodPreferences = () => (
    <Card className="w-full max-w-4xl mx-auto bg-black/40 backdrop-blur-md border-white/15">
      <CardHeader className="bg-gradient-to-br from-neutral-600 via-black/600 to-black text-white rounded-t-lg">
        <CardTitle className="text-2xl font-bold flex items-center gap-3">
          <span className="text-3xl">ðŸ½ï¸</span>
          Comprehensive Food Preferences
        </CardTitle>
        <p className="text-white/90 mt-2">
          Select all foods you enjoy eating. This comprehensive selection helps
          us create personalized meal plans with foods you actually love.
        </p>
      </CardHeader>
      <CardContent className="p-8 space-y-8">
        {/* Fruits & Vegetables */}
        {renderCheckboxSection(
          "ðŸ“ Fruits & Vegetables (20)",
          "preferredFruitsVegetables",
          foodOptions.fruitsVegetables,
          "customFruitsVegetables",
          "ex: Dragon fruit, Artichoke, Bok choy",
          true,
        )}

        {/* Proteins */}
        {renderCheckboxSection(
          "ðŸ— Proteins (20)",
          "preferredProteins",
          foodOptions.proteins,
          "customProteins",
          "ex: Duck, Venison, Quinoa",
          true,
        )}

        {/* Carbohydrates */}
        {renderCheckboxSection(
          "ðŸž Carbohydrates (20)",
          "preferredCarbohydrates",
          foodOptions.carbohydrates,
          "customCarbohydrates",
          "ex: Spelt, Kamut, Wild rice",
          true,
        )}

        {/* Fats */}
        {renderCheckboxSection(
          "ðŸ¥‘ Fats (20)",
          "preferredFats",
          foodOptions.fats,
          "customFats",
          "ex: Brazil nuts, Hemp seeds, MCT oil",
          true,
        )}

        {/* Sweeteners */}
        {renderCheckboxSection(
          "ðŸ¯ Preferred Sweeteners (16)",
          "preferredSweeteners",
          foodOptions.sweeteners,
          "customSweeteners",
          "ex: Coconut nectar, Yacon syrup",
          true,
        )}

        <div className="bg-white/10 backdrop-blur-sm p-6 rounded-lg">
          <h3 className="font-semibold text-white mb-2">How This Helps</h3>
          <p className="text-white/90">
            Your comprehensive food preferences help us create personalized meal
            plans with foods you actually enjoy. We'll prioritize these
            ingredients in your weekly meal suggestions while still maintaining
            nutritional balance and variety.
          </p>
        </div>
      </CardContent>
    </Card>
  );

  const renderWomenHormonalEvaluation = () => {
    // Only show if gender is female
    if (data.gender !== "female") {
      return (
        <Card className="w-full max-w-md mx-auto">
          <CardHeader className="bg-gradient-to-br from-neutral-600 via-black/600 to-black text-white rounded-t-lg">
            <CardTitle className="text-2xl font-bold flex items-center gap-3">
              <span className="text-3xl">âš•ï¸</span>
              Women's Hormonal Health Assessment
            </CardTitle>
          </CardHeader>
          <CardContent className="p-8 text-center">
            <p className="text-black mb-6">
              This section is specifically for women's hormonal health
              evaluation. Since you selected a different gender, we'll skip this
              step.
            </p>
            <Button
              onClick={() => setCurrentStep(13)} // Go to the next step (Men's Hormonal Evaluation)
              className="bg-gradient-to-br from-neutral-600 via-black/600 to-black px-8 py-3 text-lg"
            >
              Continue to Next Step â†’
            </Button>
          </CardContent>
        </Card>
      );
    }

    const hormonalSymptoms = [
      "Irregular periods",
      "Heavy bleeding",
      "Severe PMS",
      "Hormonal acne",
      "Mood swings during cycle",
      "Fatigue during cycle",
      "Painful cramps",
    ];

    const reproductiveHistory = [
      "Currently Pregnant",
      "Trying to conceive",
      "Breastfeeding",
      "History of miscarriage",
    ];

    const hormonalConditions = [
      "PCOS",
      "Endometriosis",
      "Perimenopause",
      "Menopause",
    ];

    return (
      <Card className="w-full max-w-4xl mx-auto bg-black/40 backdrop-blur-md border-white/15">
        <CardHeader className="bg-gradient-to-br from-neutral-600 via-black/600 to-black text-white rounded-t-lg">
          <CardTitle className="text-2xl font-bold flex items-center gap-3">
            <span className="text-3xl">âš•ï¸</span>
            Women's Hormonal Health Assessment
          </CardTitle>
          <p className="text-white/90 mt-2">
            Help us understand your hormonal health to provide personalized
            nutrition recommendations.
          </p>
        </CardHeader>
        <CardContent className="p-8 space-y-8">
          {/* Hormonal Cycle & Symptoms */}
          {renderCheckboxSection(
            "ðŸ©¸ Hormonal Cycle & Symptoms",
            "womenHormonalSymptoms",
            hormonalSymptoms,
          )}

          {/* Reproductive History */}
          {renderCheckboxSection(
            "ðŸ¤± Reproductive History",
            "womenReproductiveHistory",
            reproductiveHistory,
          )}

          {/* Hormonal Conditions */}
          {renderCheckboxSection(
            "ðŸ”¬ Hormonal Conditions",
            "womenHormonalConditions",
            hormonalConditions,
          )}

          {/* Last Menstrual Cycle */}
          <div className="space-y-3">
            <h4 className="font-semibold text-lg text-white">
              ðŸ“… Date of Last Menstrual Cycle
            </h4>
            <Input
              type="date"
              value={data.womenLastMenstrualCycle}
              onChange={(e) =>
                updateData({ womenLastMenstrualCycle: e.target.value })
              }
              className="w-full max-w-xs bg-white/20 border-white/30 text-white placeholder:text-white/70"
              aria-required="true"
              aria-invalid={
                data.gender === "female" && !data.womenLastMenstrualCycle
              }
            />
          </div>

          {/* Custom Hormonal Info */}
          <div className="space-y-3">
            <h4 className="font-semibold text-lg text-white">
              ðŸ’­ Additional Information
            </h4>
            <p className="text-sm text-white/80">
              Is there anything else you'd like us to know about your hormonal
              health?
            </p>
            <textarea
              rows={3}
              placeholder="Enter any other symptoms, history, or diagnoses..."
              value={data.womenCustomHormonalInfo}
              onChange={(e) =>
                updateData({ womenCustomHormonalInfo: e.target.value })
              }
              className="w-full p-3 bg-white/20 border-white/30 text-white placeholder:text-white/70 rounded-lg focus:ring-2 focus:ring-white/50 focus:border-white/50"
            />
          </div>

          <div className="bg-white/10 backdrop-blur-sm p-6 rounded-lg border-l-4 border-white/30">
            <h3 className="font-semibold text-white mb-2">âœ… How This Helps</h3>
            <p className="text-white/90">
              Understanding your hormonal health allows us to create meal plans
              that support your cycle, manage symptoms, and optimize your
              nutrition for different life stages. We use your age from the
              basic profile along with this hormonal information.
            </p>
          </div>
        </CardContent>
      </Card>
    );
  };

  const renderMenHormonalEvaluation = () => {
    // Only show if gender is male
    if (data.gender !== "male") {
      return (
        <Card className="w-full max-w-md mx-auto">
          <CardHeader className="bg-gradient-to-br from-neutral-600 via-black/600 to-black text-white rounded-t-lg">
            <CardTitle className="text-2xl font-bold flex items-center gap-3">
              <span className="text-3xl">âš•ï¸</span>
              Men's Hormonal Health Assessment
            </CardTitle>
          </CardHeader>
          <CardContent className="p-8 text-center">
            <p className="text-black mb-6">
              This section is specifically for men's hormonal health evaluation.
              Since you selected a different gender, we'll skip this step.
            </p>
            <Button
              onClick={() => setCurrentStep(14)} // Go to the next step (AI Voice & Journaling)
              className="bg-gradient-to-br from-neutral-600 via-black/600 to-black text-white px-8 py-3 text-lg"
            >
              Continue to Next Step â†’
            </Button>
          </CardContent>
        </Card>
      );
    }

    const energyPerformance = [
      "Low energy",
      "Decreased libido",
      "Poor muscle recovery",
      "Increased belly fat",
      "Trouble sleeping",
    ];

    const testosteroneAge = [
      "Been tested for testosterone levels",
      "Diagnosed low testosterone",
      "Mood swings or irritability",
      "Struggling with motivation/focus",
    ];

    const lifestyleHealth = [
      "High stress levels",
      "Difficulty losing fat",
      "Using testosterone replacement therapy (TRT)",
    ];

    return (
      <Card className="w-full max-w-4xl mx-auto bg-black/40 backdrop-blur-md border-white/15">
        <CardHeader className="bg-gradient-to-br from-neutral-600 via-black/600 to-black text-white rounded-t-lg">
          <CardTitle className="text-2xl font-bold flex items-center gap-3">
            <span className="text-3xl">âš•ï¸</span>
            Men's Hormonal Health Assessment
          </CardTitle>
          <p className="text-white/90 mt-2">
            Help us understand your hormonal health to provide personalized
            nutrition recommendations.
          </p>
        </CardHeader>
        <CardContent className="p-8 space-y-8">
          {/* Energy & Performance */}
          {renderCheckboxSection(
            "âš¡ Energy & Performance",
            "menEnergyPerformance",
            energyPerformance,
          )}

          {/* Testosterone & Age */}
          {renderCheckboxSection(
            "ðŸ§¬ Testosterone & Age",
            "menTestosteroneAge",
            testosteroneAge,
          )}

          {/* Lifestyle & Health */}
          {renderCheckboxSection(
            "ðŸƒ Lifestyle & Health",
            "menLifestyleHealth",
            lifestyleHealth,
          )}

          {/* Age Assessment */}
          <div className="space-y-3">
            <h4 className="font-semibold text-lg text-white">
              ðŸ“Š Age-Related Health Factors
            </h4>
            <p className="text-sm text-white/80">
              Select any age-related concerns that apply to you:
            </p>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              {[
                "Testosterone decline after 30",
                "Slower metabolism",
                "Increased recovery time",
                "Joint stiffness",
                "Sleep quality issues",
                "Mental clarity concerns",
              ].map((factor) => (
                <button
                  key={factor}
                  onClick={() => {
                    const currentFactors = data.menTestosteroneAge || [];
                    const isSelected = currentFactors.includes(factor);
                    updateData({
                      menTestosteroneAge: isSelected
                        ? currentFactors.filter((f) => f !== factor)
                        : [...currentFactors, factor],
                    });
                  }}
                  className={`p-3 rounded-lg border-2 transition-all duration-200 text-left hover:shadow-md ${
                    (data.menTestosteroneAge || []).includes(factor)
                      ? "border-white bg-white/30 text-white shadow-md"
                      : "border-white/30 bg-white/10 text-white/90 hover:border-white/50 hover:bg-white/20"
                  }`}
                >
                  <span className="font-medium text-sm">{factor}</span>
                </button>
              ))}
            </div>
          </div>

          {/* Custom Hormonal Info */}
          <div className="space-y-3">
            <h4 className="font-semibold text-lg text-white">
              ðŸ’­ Additional Information
            </h4>
            <p className="text-sm text-white/80">
              Anything else related to your hormonal or physical health we
              should consider?
            </p>
            <textarea
              rows={3}
              placeholder="Enter details not listed above..."
              value={data.menCustomHormonalInfo}
              onChange={(e) =>
                updateData({ menCustomHormonalInfo: e.target.value })
              }
              className="w-full p-3 bg-white/20 border-white/30 text-white placeholder:text-white/70 rounded-lg focus:ring-2 focus:ring-white/50 focus:border-white/50"
            />
          </div>

          <div className="bg-white/10 backdrop-blur-sm p-6 rounded-lg border-l-4 border-white/30">
            <h3 className="font-semibold text-white mb-2">âœ… How This Helps</h3>
            <p className="text-white/90">
              Understanding your hormonal health allows us to create meal plans
              that support testosterone levels, energy production, and overall
              male health optimization. We use your age from the basic profile
              along with this hormonal information to provide targeted
              nutritional support.
            </p>
          </div>
        </CardContent>
      </Card>
    );
  };

  const renderHormonalHealth = () => {
    if (data.gender !== "female" && data.gender !== "male") {
      // Show placeholder if gender is not specified or not relevant
      return (
        <Card className="w-full max-w-md mx-auto">
          <CardHeader>
            <CardTitle className="text-center">Hormonal Health</CardTitle>
          </CardHeader>
          <CardContent className="text-center">
            <p className="text-gray-600 mb-4">
              Please select your gender to tailor the hormonal health
              assessment.
            </p>
          </CardContent>
        </Card>
      );
    } else if (data.gender === "female") {
      return renderWomenHormonalEvaluation();
    } else {
      // gender === "male"
      return renderMenHormonalEvaluation();
    }
  };

  const renderAIVoiceJournaling = () => {
    return (
      <Card className="w-full max-w-md mx-auto bg-black/40 backdrop-blur-md border-white/15">
        <CardHeader className="text-center bg-gradient-to-br from-neutral-600 via-black/600 to-black text-white rounded-t-lg">
          <CardTitle className="text-2xl md:text-3xl font-bold">
            ðŸŽ¯ Final Preferences
          </CardTitle>
          <p className="text-white/90 mt-2">
            Configure your final meal planning preferences
          </p>
          <div className="bg-black/50 p-3 rounded-lg mt-4">
            <p className="text-xs sm:text-sm text-white">
              These AI-powered features help personalize your nutrition journey
              and provide ongoing support and motivation.
            </p>
          </div>
        </CardHeader>
        <CardContent className="p-4 sm:p-8">
          <div className="space-y-4 sm:space-y-6">
            <div>
              <h3 className="text-lg font-semibold text-white mb-3 sm:mb-4">
                Journaling Preferences
              </h3>
              <div className="space-y-2 sm:space-y-3">
                <label className="flex items-start space-x-3 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={data.enableJournaling || false}
                    onChange={(e) =>
                      updateData({
                        enableJournaling: e.target.checked,
                        journalingPreferences: {
                          ...data.journalingPreferences,
                          enableDailyJournaling: e.target.checked,
                        },
                      })
                    }
                    className="h-4 w-4 rounded border-white/30 mt-1 flex-shrink-0"
                  />
                  <span className="text-white text-sm sm:text-base">Enable Daily Journaling</span>
                </label>
                <label className="flex items-start space-x-3 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={data.moodTracking || false}
                    onChange={(e) =>
                      updateData({
                        moodTracking: e.target.checked,
                        journalingPreferences: {
                          ...data.journalingPreferences,
                          enableMoodTracking: e.target.checked,
                        },
                      })
                    }
                    className="h-4 w-4 rounded border-white/30 mt-1 flex-shrink-0"
                  />
                  <span className="text-white text-sm sm:text-base">Enable Mood Tracking</span>
                </label>
                <label className="flex items-start space-x-3 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={data.journalingPreferences?.enableGoalTracking || false}
                    onChange={(e) =>
                      updateData({
                        journalingPreferences: {
                          ...data.journalingPreferences,
                          enableGoalTracking: e.target.checked,
                        },
                      })
                    }
                    className="h-4 w-4 rounded border-white/30 mt-1 flex-shrink-0"
                  />
                  <span className="text-white text-sm sm:text-base">Enable Goal Tracking</span>
                </label>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    );
  };

  const renderAccountabilityPreferences = () => (
    <Card className="w-full max-w-2xl mx-auto bg-black/40 backdrop-blur-md border-white/15">
      <CardHeader className="bg-gradient-to-br from-neutral-600 via-black/600 to-black text-white rounded-t-lg text-center">
        <CardTitle className="text-center">
          Progress Tracking & Accountability
        </CardTitle>
        <p className="text-center text-white/90 mt-2">
          Choose how you'd like to track your progress and stay accountable to
          your goals
        </p>
      </CardHeader>
      <CardContent className="space-y-6 text-white">
        {/* Weigh-in Frequency */}
        <div>
          <Label className="text-base font-medium mb-3 block">
            How often do you want to weigh yourself?
          </Label>
          <RadioGroup
            value={data.weighInFrequency}
            onValueChange={(value) => updateData({ weighInFrequency: value })}
            className="space-y-2"
          >
            <div className="flex items-center space-x-2">
              <RadioGroupItem value="daily" id="daily" />
              <Label htmlFor="daily">
                Daily (for data-driven people who like frequent feedback)
              </Label>
            </div>
            <div className="flex items-center space-x-2">
              <RadioGroupItem value="weekly" id="weekly" />
              <Label htmlFor="weekly">
                Weekly (most common - consistent without being obsessive)
              </Label>
            </div>
            <div className="flex items-center space-x-2">
              <RadioGroupItem value="monthly" id="monthly" />
              <Label htmlFor="monthly">
                Monthly (focus on long-term trends)
              </Label>
            </div>
            <div className="flex items-center space-x-2">
              <RadioGroupItem value="never" id="never" />
              <Label htmlFor="never">
                Never (I prefer other tracking methods)
              </Label>
            </div>
          </RadioGroup>
        </div>

        {/* Body Measurements */}
        <div>
          <Label className="text-base font-medium mb-3 block">
            Additional Tracking Methods
          </Label>
          <div className="space-y-3">
            <div className="flex items-center space-x-2">
              <input
                type="checkbox"
                id="bodyMeasurements"
                checked={data.bodyMeasurements}
                onChange={(e) =>
                  updateData({ bodyMeasurements: e.target.checked })
                }
                className="h-4 w-4 rounded border-white/30"
              />
              <Label htmlFor="bodyMeasurements">
                Body measurements (waist, hips, arms, etc.)
              </Label>
            </div>
            <div className="flex items-center space-x-2">
              <input
                type="checkbox"
                id="bodyFatTracking"
                checked={data.bodyFatTracking}
                onChange={(e) =>
                  updateData({ bodyFatTracking: e.target.checked })
                }
                className="h-4 w-4 rounded border-white/30"
              />
              <Label htmlFor="bodyFatTracking">
                Body fat percentage (if you have access to testing)
              </Label>
            </div>
            <div className="flex items-center space-x-2">
              <input
                type="checkbox"
                id="progressPhotos"
                checked={data.progressPhotos}
                onChange={(e) =>
                  updateData({ progressPhotos: e.target.checked })
                }
                className="h-4 w-4 rounded border-white/30"
              />
              <Label htmlFor="progressPhotos">
                Progress photos (visual tracking)
              </Label>
            </div>
          </div>
        </div>

        {/* Accountability Style */}
        <div>
          <Label className="text-base font-medium mb-3 block">
            What type of accountability works best for you?
          </Label>
          <RadioGroup
            value={data.accountabilityStyle}
            onValueChange={(value) =>
              updateData({ accountabilityStyle: value })
            }
            className="space-y-2"
          >
            <div className="flex items-center space-x-2">
              <RadioGroupItem value="self-directed" id="self-directed" />
              <Label htmlFor="self-directed">
                Self-directed (I track my own progress)
              </Label>
            </div>
            <div className="flex items-center space-x-2">
              <RadioGroupItem value="gentle-reminders" id="gentle-reminders" />
              <Label htmlFor="gentle-reminders">
                Gentle reminders (occasional check-ins and encouragement)
              </Label>
            </div>
            <div className="flex items-center space-x-2">
              <RadioGroupItem value="structured" id="structured" />
              <Label htmlFor="structured">
                Structured check-ins (regular scheduled accountability)
              </Label>
            </div>
            <div className="flex items-center space-x-2">
              <RadioGroupItem value="goal-focused" id="goal-focused" />
              <Label htmlFor="goal-focused">
                Goal-focused (milestone-based accountability)
              </Label>
            </div>
          </RadioGroup>
        </div>

        {/* Check-in Frequency */}
        <div>
          <Label className="text-base font-medium mb-3 block">
            How often should we check in on your progress?
          </Label>
          <Select
            value={data.checkInFrequency}
            onValueChange={(value) => updateData({ checkInFrequency: value })}
          >
            <SelectTrigger>
              <SelectValue placeholder="Select frequency" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="daily">Daily</SelectItem>
              <SelectItem value="weekly">Weekly</SelectItem>
              <SelectItem value="biweekly">Every 2 weeks</SelectItem>
              <SelectItem value="monthly">Monthly</SelectItem>
              <SelectItem value="as-needed">Only when I ask</SelectItem>
            </SelectContent>
          </Select>
        </div>

        {/* Preferred Check-in Time */}
        <div>
          <Label className="text-base font-medium mb-3 block">
            When do you prefer to do check-ins?
          </Label>
          <Select
            value={data.preferredCheckInTime}
            onValueChange={(value) =>
              updateData({ preferredCheckInTime: value })
            }
          >
            <SelectTrigger>
              <SelectValue placeholder="Select preferred time" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="morning">
                Morning (start the day with intention)
              </SelectItem>
              <SelectItem value="evening">
                Evening (reflect on the day)
              </SelectItem>
              <SelectItem value="weekend">
                Weekend (more time to focus)
              </SelectItem>
              <SelectItem value="flexible">Flexible (anytime works)</SelectItem>
            </SelectContent>
          </Select>
        </div>

        {/* Goal Review Frequency */}
        <div>
          <Label className="text-base font-medium mb-3 block">
            How often should we review and adjust your goals?
          </Label>
          <Select
            value={data.goalReviewFrequency}
            onValueChange={(value) =>
              updateData({ goalReviewFrequency: value })
            }
          >
            <SelectTrigger>
              <SelectValue placeholder="Select review frequency" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="weekly">Weekly</SelectItem>
              <SelectItem value="biweekly">Every 2 weeks</SelectItem>
              <SelectItem value="monthly">Monthly</SelectItem>
              <SelectItem value="quarterly">Every 3 months</SelectItem>
              <SelectItem value="when-needed">
                Only when I feel stuck
              </SelectItem>
            </SelectContent>
          </Select>
        </div>
      </CardContent>
    </Card>
  );

  // Initialize step progress hook for Save Progress functionality
  const { saveStep } = useStepProgress(`step-${currentStep}`, userId?.toString());

  // Save Progress handler (uses existing toast from line 331)
  const handleSaveProgress = () => {
    console.log("ðŸ”§ Manual save triggered:", { step: currentStep, formData: data });
    
    // Check if current step is valid before saving
    if (!isStepValid()) {
      setShowValidation(true);
      toast({
        title: "Missing Required Fields",
        description: "Please fill in all required fields highlighted in red.",
        variant: "destructive",
        duration: 5000,
      });
      // Scroll to top so user can see the red fields
      setTimeout(() => scrollToTop(), 0);
      return;
    }
    
    saveStep.mutate({ 
      data: data, 
      completed: false, 
      apply: true 
    }, {
      onSuccess: (result) => {
        console.log("âœ… Manual save successful:", result);
        toast({
          title: "Progress Saved!",
          description: "Your onboarding data has been saved successfully.",
          duration: 3000,
        });
      },
      onError: (error) => {
        console.error("âŒ Manual save failed:", error);
        toast({
          title: "Save Failed",
          description: `Unable to save your progress: ${error.message}`,
          variant: "destructive",
          duration: 5000,
        });
      }
    });
  };

  const fillDummyData = () => {
    setData({
      ...data,
      firstName: "John",
      lastName: "Doe",
      age: 30,
      gender: "male",
      height: 70,
      weight: 180,
      activityLevel: "moderate",
      bodyType: "meso",
      primaryGoal: "weight_loss",
      goalTimeline: "3_months",
      targetWeight: 170,
      weeklyWeightLoss: 1,
      medicalConditions: ["diabetes-type2", "shellfish-allergy"],
      foodAllergies: ["tree-nuts"],
      dietaryRestrictions: ["vegetarian"],
      customMedicalConditions: { metabolic: "A new metabolic issue" },
      customAllergies: ["gluten"],
      customRestrictions: ["keto"],
      customMedicalLabels: { "custom-metabolic-123": "A new metabolic issue" },
      weighInFrequency: "weekly",
      bodyMeasurements: true,
      bodyFatTracking: true,
      progressPhotos: false,
      accountabilityStyle: "gentle-reminders",
      checkInFrequency: "daily",
      preferredCheckInTime: "morning",
      goalReviewFrequency: "weekly",
      psychologicalProfile: {
        structureResponse: "love_structure",
        setbackResponse: "bounce_back",
        primaryMotivation: "feeling_better",
        foodDecisionMaking: "follow_plan",
        accountabilityPreference: "tracking_tools",
        foodRelationship: "fuel_enjoy",
        longTermConfidence: "very_confident",
        cravingAttitude: "include_without_guilt",
        persistenceDriver: "long_term_vision",
        learningStyle: "show_tell_why",
      },
      womenHormonalSymptoms: [],
      womenReproductiveHistory: [],
      womenHormonalConditions: [],
      womenAge: 0,
      womenLastMenstrualCycle: "",
      womenCustomHormonalInfo: "",
      menEnergyPerformance: [],
      menTestosteroneAge: [],
      menLifestyleHealth: [],
      menAge: 0,
      menCustomHormonalInfo: "",
      enableVoiceAssistant: true,
      enableJournaling: true,
      journalingMethod: "both",
      dailyReminder: true,
      reminderTime: "20:00",
      journalingFocusAreas: ["emotional_eating", "progress_tracking"],
      emotionalCheckIns: true,
      moodTracking: true,
      aiVoicePreferences: {
        enableVoiceAssistant: true,
        enableVoiceReminders: true,
        enableDailyCheckin: true,
      },
      journalingPreferences: {
        enableDailyJournaling: true,
        enableMoodTracking: true,
        enableGoalTracking: true,
      },
    });
  };

  const renderPsychologicalProfile = () => (
    <>
      <Card className="w-full max-w-4xl mx-auto bg-black/40 backdrop-blur-md border-white/15">
        <CardHeader className="bg-gradient-to-br from-neutral-600 via-black/600 to-black text-white rounded-t-lg">
          <CardTitle className="text-2xl font-bold flex items-center gap-3">
            <span className="text-3xl">ðŸ§ </span>
            Psychological Profile Assessment
          </CardTitle>
          <p className="text-white/90 mt-2">
            The more we understand your mindset, the better we can support your
            success. Answer honestlyâ€”there are no right or wrong answers.
          </p>
        </CardHeader>
        <CardContent className="p-8 space-y-8">
          {psychQuestions.map((question, index) => (
            <div key={question.field} className="space-y-4">
              <div className="flex items-center gap-3 mb-4">
                <div className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center">
                  <span className="text-white font-semibold">{index + 1}</span>
                </div>
                <Label className="text-lg font-semibold text-white">
                  {question.question}
                </Label>
              </div>

              <div className="grid grid-cols-1 gap-3 ml-0 sm:ml-11">
                {question.options.map((option) => (
                  <button
                    key={option.value}
                    onClick={() => {
                      updateData({
                        psychologicalProfile: {
                          ...data.psychologicalProfile,
                          [question.field]: option.value,
                        },
                      });
                    }}
                    className={`p-3 sm:p-4 rounded-lg border-2 transition-all duration-200 text-left hover:shadow-md w-full ${
                      data.psychologicalProfile[
                        question.field as keyof typeof data.psychologicalProfile
                      ] === option.value
                        ? "border-white bg-white/30 text-white shadow-md"
                        : "border-white/30 bg-white/10 text-white/90 hover:border-white/50 hover:bg-white/20"
                    }`}
                  >
                    <div className="font-medium text-sm sm:text-base leading-tight">
                      {option.label}
                    </div>
                  </button>
                ))}
              </div>
            </div>
          ))}

          <div className="bg-white/10 backdrop-blur-sm p-6 rounded-lg mt-8">
            <h3 className="font-semibold text-white mb-4">
              âœ… How This Helps You
            </h3>
            <p className="text-white/90 mb-4">
              Your answers will shape how My Perfect Meals personalizes:
            </p>
            <ul className="text-white/90 space-y-2">
              <li>â€¢ Your daily experience (structured vs. flexible)</li>
              <li>â€¢ Meal reminders and nudges</li>
              <li>â€¢ Progress tracking or low-pressure coaching</li>
              <li>â€¢ Craving and dessert allowances</li>
              <li>
                â€¢ How we deliver supportâ€”gentle, firm, visual, or
                community-based
              </li>
            </ul>
          </div>

          <div className="bg-white/10 backdrop-blur-sm p-6 rounded-lg mt-4 border-l-4 border-white/30">
            <h3 className="font-semibold text-white mb-4">
              âœ… Psychological Frameworks & Citations
            </h3>
            <p className="text-white/90 mb-4 text-sm">
              These questions are based on established psychological research
              frameworks:
            </p>

            <div className="space-y-4 text-sm">
              <div>
                <h4 className="font-semibold text-white">
                  Transtheoretical Model of Change
                </h4>
                <p className="text-white/90">
                  <strong>Citation:</strong> Prochaska, J. O., & DiClemente, C.
                  C. (1983). Journal of Consulting and Clinical Psychology,
                  51(3), 390â€“395.
                </p>
              </div>

              <div>
                <h4 className="font-semibold text-white">
                  Self-Determination Theory
                </h4>
                <p className="text-white/90">
                  <strong>Citation:</strong> Deci, E. L., & Ryan, R. M. (1985).
                  Intrinsic motivation and self-determination in human behavior.
                  Springer.
                </p>
              </div>

              <div>
                <h4 className="font-semibold text-white">
                  Four Tendencies Framework
                </h4>
                <p className="text-white/90">
                  <strong>Citation:</strong> Rubin, G. (2017). The Four
                  Tendencies. Harmony Books.
                </p>
              </div>

              <div>
                <h4 className="font-semibold text-white">
                  Motivational Interviewing
                </h4>
                <p className="text-white/90">
                  <strong>Citation:</strong> Miller, W. R., & Rollnick, S.
                  (2013). Motivational Interviewing: Helping People Change (3rd
                  ed.). Guilford Press.
                </p>
              </div>

              <div>
                <h4 className="font-semibold text-white">
                  Cognitive Behavioral Coaching
                </h4>
                <p className="text-white/90">
                  <strong>Citation:</strong> Neenan, M., & Palmer, S. (2001).
                  Cognitive Behavioural Coaching. BPS Blackwell.
                </p>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    </>
  );

  const renderFoodsToAvoid = () => {
    const handleAddCustomFood = () => {
      const trimmed = customFood.trim().toLowerCase();
      if (trimmed && !data.avoidedFoods.includes(trimmed)) {
        updateData({ avoidedFoods: [...data.avoidedFoods, trimmed] });
        setCustomFood("");
      }
    };

    const handleRemoveFood = (foodToRemove: string) => {
      updateData({
        avoidedFoods: data.avoidedFoods.filter((f) => f !== foodToRemove),
      });
    };

    return (
      <div className="max-w-6xl mx-auto">
        <Card className="w-full mx-auto bg-black/40 backdrop-blur-md border-white/15">
          <CardHeader className="text-center bg-gradient-to-br from-neutral-600 via-black/600 to-black text-white rounded-t-lg">
            <CardTitle className="text-2xl md:text-3xl font-bold">
              Foods to Avoid
            </CardTitle>
            <p className="text-white/90 mt-2">
              Tell us what foods you don't want in your meal plans
            </p>
          </CardHeader>
          <CardContent className="p-8 space-y-8">
            {/* Foods to Avoid Section */}
            <div>
              <h3 className="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                ðŸš« Add Custom Foods to Avoid
              </h3>
              <p className="text-white/90 mb-4">
                Enter any foods you want to avoid (allergies, dislikes, dietary
                restrictions, etc.)
              </p>
              <div className="flex gap-2">
                <Input
                  value={customFood}
                  onChange={(e) => setCustomFood(e.target.value)}
                  onKeyPress={(e) => {
                    if (e.key === "Enter") {
                      e.preventDefault();
                      handleAddCustomFood();
                    }
                  }}
                  placeholder="e.g., peanuts, dairy, shellfish..."
                  className="flex-1 text-white"
                />
                <Button
                  onClick={handleAddCustomFood}
                  disabled={!customFood.trim()}
                  variant="outline"
                  size="sm"
                  className="px-4"
                >
                  Add
                </Button>
              </div>

              {/* Display added foods */}
              {data.avoidedFoods.length > 0 && (
                <div className="mt-4 space-y-2">
                  <h4 className="text-sm font-medium text-white">
                    Foods You're Avoiding:
                  </h4>
                  <div className="flex flex-wrap gap-2">
                    {data.avoidedFoods.map((food) => (
                      <Badge
                        key={food}
                        variant="secondary"
                        className="flex items-center gap-2 bg-white/20 text-white"
                      >
                        {food}
                        <button
                          onClick={() => handleRemoveFood(food)}
                          className="hover:text-red-400"
                        >
                          <X className="h-3 w-3" />
                        </button>
                      </Badge>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* Sweeteners to Avoid Section */}
            <div>
              <h3 className="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                ðŸ¯ Sweeteners to Avoid
              </h3>
              <p className="text-white/90 mb-4">
                Select any sweeteners you want to avoid in your meal plans
              </p>
              {renderCheckboxSection(
                "",
                "avoidSweeteners",
                foodOptions.sweeteners,
              )}
            </div>

            {/* Educational Content */}
            <div className="bg-white/10 backdrop-blur-sm p-6 rounded-lg border-l-4 border-white/30">
              <h3 className="font-semibold text-white mb-4">ðŸ’¡ How This Helps</h3>
              <ul className="text-white/90 space-y-2">
                <li>
                  â€¢ <strong>Avoided foods</strong> will never appear in your meal
                  plans
                </li>
                <li>
                  â€¢ Our AI considers your preferences when creating personalized
                  nutrition plans
                </li>
                <li>
                  â€¢ You can update these preferences anytime in your profile
                  settings
                </li>
              </ul>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  };

  const renderGlycemicPreferences = () => {
    const lowGIOptions = [
      "Berries",
      "Cherries", 
      "Apples",
      "Pears",
      "Grapefruit",
      "Leafy Greens",
      "Broccoli",
      "Cauliflower",
      "Zucchini",
      "Green Beans",
      "Lentils",
      "Chickpeas",
      "Black Beans",
      "Quinoa",
      "Steel-cut Oats",
      "Sweet Potato (small)",
      "Carrots",
      "Tomatoes",
      "Cucumber",
      "Peppers"
    ];

    const midGIOptions = [
      "Brown Rice",
      "Whole Wheat Pasta",
      "Whole Grain Bread",
      "Couscous",
      "Pineapple",
      "Bananas",
      "Corn",
      "Sweet Potato (medium)",
      "Basmati Rice"
    ];

    const highGIOptions = [
      "White Rice",
      "White Bread",
      "Potatoes (baked)",
      "Watermelon",
      "Dates",
      "Rice Cakes",
      "Instant Oatmeal"
    ];

    return (
      <div className="max-w-6xl mx-auto">
        <Card className="w-full mx-auto bg-black/40 backdrop-blur-md border-white/15">
          <CardHeader className="text-center bg-gradient-to-br from-neutral-600 via-black/600 to-black text-white rounded-t-lg">
            <CardTitle className="text-2xl md:text-3xl font-bold">
              ðŸ¥¬ Low Glycemic Carb Preferences
            </CardTitle>
            <p className="text-white/90 mt-2">
              Select your preferred low, mid, and high glycemic carbs to personalize your meal recommendations
            </p>
          </CardHeader>
          <CardContent className="p-8 space-y-8">
            {/* Low GI Foods */}
            <div className="space-y-4">
              <h3 className="text-xl font-semibold text-white flex items-center gap-2">
                <span className="text-2xl">ðŸŸ¢</span>
                Low Glycemic Index Foods
              </h3>
              <p className="text-white/80 text-sm">Best for stable blood sugar</p>
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                {lowGIOptions.map((option) => (
                  <div key={option} className="flex items-center space-x-2">
                    <input
                      type="checkbox"
                      id={`low-gi-${option}`}
                      checked={(data.preferredLowGICarbs || []).includes(option)}
                      onChange={() => handleArrayToggle("preferredLowGICarbs", option)}
                      className="h-4 w-4 rounded border-white/30"
                    />
                    <label
                      htmlFor={`low-gi-${option}`}
                      className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 text-white"
                    >
                      {option}
                    </label>
                  </div>
                ))}
              </div>
            </div>

            {/* Mid GI Foods */}
            <div className="space-y-4">
              <h3 className="text-xl font-semibold text-white flex items-center gap-2">
                <span className="text-2xl">ðŸŸ¡</span>
                Mid Glycemic Index Foods
              </h3>
              <p className="text-white/80 text-sm">Moderate energy release</p>
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                {midGIOptions.map((option) => (
                  <div key={option} className="flex items-center space-x-2">
                    <input
                      type="checkbox"
                      id={`mid-gi-${option}`}
                      checked={(data.preferredMidGICarbs || []).includes(option)}
                      onChange={() => handleArrayToggle("preferredMidGICarbs", option)}
                      className="h-4 w-4 rounded border-white/30"
                    />
                    <label
                      htmlFor={`mid-gi-${option}`}
                      className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 text-white"
                    >
                      {option}
                    </label>
                  </div>
                ))}
              </div>
            </div>

            {/* High GI Foods */}
            <div className="space-y-4">
              <h3 className="text-xl font-semibold text-white flex items-center gap-2">
                <span className="text-2xl">ðŸ”´</span>
                High Glycemic Index Foods
              </h3>
              <p className="text-white/80 text-sm">Quick energy, use sparingly</p>
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                {highGIOptions.map((option) => (
                  <div key={option} className="flex items-center space-x-2">
                    <input
                      type="checkbox"
                      id={`high-gi-${option}`}
                      checked={(data.preferredHighGICarbs || []).includes(option)}
                      onChange={() => handleArrayToggle("preferredHighGICarbs", option)}
                      className="h-4 w-4 rounded border-white/30"
                    />
                    <label
                      htmlFor={`high-gi-${option}`}
                      className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 text-white"
                    >
                      {option}
                    </label>
                  </div>
                ))}
              </div>
            </div>

            <div className="bg-white/10 backdrop-blur-sm p-6 rounded-lg border-l-4 border-white/30">
              <h3 className="font-semibold text-white mb-4">ðŸ’¡ How This Helps</h3>
              <ul className="text-white/90 space-y-2">
                <li>â€¢ <strong>Low GI foods</strong> help maintain stable blood sugar levels</li>
                <li>â€¢ <strong>Mid GI foods</strong> provide balanced energy release</li>
                <li>â€¢ <strong>High GI foods</strong> are useful for quick energy but used sparingly</li>
                <li>â€¢ Your selections will prioritize appropriate carbs in meal recommendations</li>
              </ul>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  };

  return (
    <div className="onboarding-dark min-h-screen bg-gradient-to-br from-neutral-600 via-black/600 to-black p-6">
      <div className="max-w-5xl mx-auto">
        {/* Progress indicator */}
        <div className="mb-8">
          <div className="flex justify-between items-center mb-2">
            <span className="text-sm font-medium text-white">
              Step {currentStep} of {TOTAL_STEPS}
            </span>
            <span className="text-sm text-white">
              {Math.round((currentStep / TOTAL_STEPS) * 100)}% Complete
            </span>
          </div>
          <div className="w-full bg-white rounded-full h-2">
            <div
              className="bg-black h-2 rounded-full transition-all duration-300"
              style={{ width: `${(currentStep / TOTAL_STEPS) * 100}%` }}
            />
          </div>
        </div>

        {/* Step content - Manual save only to prevent API spam */}
        <div className="mb-8">{renderCurrentStep()}</div>

        {/* Navigation buttons - Conditional grid layout */}
        <div className={`grid gap-4 w-full ${currentStep === 1 ? 'grid-cols-2' : 'grid-cols-3'}`}>
          {/* Back Button - Black - Only show on Step 2+ */}
          {currentStep > 1 && (
            <Button
              type="button"
              onClick={handleBack}
              className="bg-black hover:bg-black/80 text-white border border-white/20 backdrop-blur-md flex items-center justify-center gap-2"
              data-testid="button-back"
            >
              <ArrowLeft className="h-4 w-4" />
              <span className="hidden sm:inline">Back</span>
            </Button>
          )}

          {/* Save Button - Red */}
          <Button 
            type="button"
            onClick={handleSaveProgress}
            disabled={saveStep.isPending}
            className="bg-red-600 hover:bg-red-700 text-white backdrop-blur-md flex items-center justify-center whitespace-nowrap min-h-[44px] px-3 sm:px-4"
            data-testid="button-save-progress"
          >
            {saveStep.isPending ? "Saving..." : "Save"}
          </Button>

          {/* Next Button - Green */}
          <Button
            type="button"
            onClick={handleNext}
            disabled={!isStepValid() || isSubmitting}
            className="bg-green-600 hover:bg-green-700 text-white backdrop-blur-md flex items-center justify-center gap-2 whitespace-nowrap min-h-[44px] px-3 sm:px-4"
            data-testid="button-next"
          >
            {currentStep === 16 ? (
              isSubmitting ? (
                "Creating..."
              ) : (
                <>
                  <span className="hidden sm:inline">Complete Setup</span>
                  <span className="sm:hidden">Done</span>
                </>
              )
            ) : (
              <>
                <span className="hidden sm:inline">Next</span>
                <span className="sm:hidden">Next</span>
                <ChevronRight className="h-4 w-4" />
              </>
            )}
          </Button>
        </div>
      </div>
    </div>
  );
}