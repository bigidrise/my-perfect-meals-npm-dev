Good question ‚Äî and yes, this is **exactly where teams either get disciplined or keep chasing ghosts**. We‚Äôre going to lock this down cleanly.

I‚Äôll answer **where this work happens** first (that‚Äôs critical), then give you the **copy-paste Replit Architect prompt**.

---

## ‚úÖ WHERE THIS WORK SHOULD HAPPEN (NO AMBIGUITY)

**You do NOT do this work in production. Period.**

Production is **read-only** except for emergency hotfix deploys.

### Correct flow (Facebook-style)

1. **Development app (repl.development)** ‚Üê ALL work happens here
2. Push to **Git**
3. Promote to **staging**
4. Validate stability in staging
5. Promote to **production**
6. THEN do TestFlight

### Why

* Production is already polluted with broken code paths
* You need a clean, controlled environment to rebuild safely
* Stability means **identical code across all environments**, not ad-hoc fixes

üëâ **Yes ‚Äî move out of production immediately.**
Open the **development Repl**, and that becomes the source of truth.

---

## üîí ENVIRONMENT PARITY RULE (NON-NEGOTIABLE)

Before anything ships:

* `development`, `staging`, and `production` must have:

  * identical code
  * identical feature flags
  * identical generator routing
* Only secrets differ (keys), not logic

We‚Äôll explicitly enforce this in the architect task.

---

# üìã COPY-PASTE REPLIT ARCHITECT PROMPT

You can paste this **exactly as-is**.

---

### **Replit Architect Directive ‚Äî Production Stability & Generator Repair**

We are pausing all TestFlight submissions until backend stability is fixed.

## Context

Two user-facing features are unstable:

* **Craving Creator**
* **Create with AI**

Root cause is confirmed:

* `stableMealGenerator.ts` is corrupted (‚âà69 TypeScript errors)
* It references missing types, constants, and functions
* Any feature using this module fails at runtime

All other AI features work because they use **independent generators**:

* Fridge Rescue ‚Üí `fridgeRescueGenerator.ts`
* Restaurant Guide ‚Üí `restaurantMealGenerator.ts`
* Dessert Creator ‚Üí `dessert-creator.ts`
* Find Meals ‚Üí working generator

This is **not** an OpenAI key issue.

---

## IMPORTANT RULES

* **All work must be done in the DEVELOPMENT Repl only**
* Production must not be modified directly
* Final solution must be identical across dev ‚Üí staging ‚Üí prod
* No silent failures
* No ‚Äúit might work‚Äù code

---

## PHASE 1 ‚Äî IMMEDIATE HOTFIX (CRITICAL)

Goal: unblock users and stop runtime failures.

### Tasks

1. **Disable or bypass `stableMealGenerator.ts`**

   * Reroute:

     * Craving Creator
     * Create with AI
   * Use a known-good generator (e.g. `universalMealGenerator.ts` or equivalent)

2. **Add hard fallback logic**

   * If AI generation fails:

     * return a deterministic, template-based meal
     * never return ‚Äúfailed to generate‚Äù to the user

3. **Add feature flags**

   * `CRAVING_CREATOR_ENABLED`
   * `CREATE_WITH_AI_ENABLED`
   * Flags must allow disabling these features without redeploy

---

## PHASE 2 ‚Äî REBUILD stableMealGenerator (HIGH PRIORITY)

Goal: one clean, shared generator that cannot fail silently.

### Requirements

* Rebuild `stableMealGenerator.ts` using:

  * existing logic from `mealEngineService.ts`
  * `universalMealGenerator.ts`
* Remove ALL references to:

  * undefined types
  * undefined constants
  * undefined functions
* All imports must resolve
* Strict typing enforced

### Acceptance Criteria

* `tsc --noEmit` passes with **zero errors**
* Generator handles missing/optional inputs safely
* Generator returns a valid schema or a controlled fallback

---

## PHASE 3 ‚Äî STABILITY LAYER (FACEBOOK-LEVEL REQUIREMENT)

Add resilience around **every AI route**:

1. **Timeouts**

   * Hard timeout on AI calls (no infinite waits)

2. **Retries**

   * Retry once on transient errors (timeouts, 502/503)
   * No retries on validation errors

3. **Circuit Breaker**

   * If a route fails N times in a window:

     * stop calling AI
     * return fallback
     * log failure
     * auto-recover after cooldown

4. **Observability**
   Each AI request must log:

   * request ID
   * generator name
   * duration
   * error category (timeout, validation, provider, unknown)

---

## PHASE 4 ‚Äî TESTING & ENV PARITY

1. **Smoke tests** for all AI routes:

   * Craving Creator
   * Create with AI
   * Fridge Rescue
   * Restaurant Guide
   * Dessert Creator

2. **Health endpoint**

   * `/api/health/ai`
   * Confirms:

     * required secrets exist
     * provider reachable
     * model configured

3. **Environment parity**

   * dev, staging, prod must run identical code
   * no environment-specific logic branches

---

## PHASE 5 ‚Äî RELEASE GATE (MANDATORY)

Before any TestFlight build:

* Zero TypeScript errors
* All AI smoke tests passing
* Health endpoint green
* Feature flags verified
* Fallback paths tested

If any fail:
üö´ No TestFlight submission.

---

## Deliverables

* Working hotfix reroute
* Rebuilt `stableMealGenerator.ts`
* Stability layer implemented
* Smoke tests + health check
* Confirmation that dev ‚Üí staging ‚Üí prod are identical

---

### END DIRECTIVE

---

## üß≠ Final Answer to Your Question (Plain English)

* **Yes**, move to the **development app now**
* Do **all fixes there**
* Push to Git
* Promote to staging
* Verify stability
* Promote to production
* THEN do TestFlight #4

Anything else is wasted motion.

When the architect responds with:

* what they rerouted
* what generator they used
* what errors were fixed
* how they‚Äôre enforcing parity

Bring it back here and we‚Äôll audit it like a production release review.

You‚Äôre doing the right thing by stopping.
This is how real systems get stable.
