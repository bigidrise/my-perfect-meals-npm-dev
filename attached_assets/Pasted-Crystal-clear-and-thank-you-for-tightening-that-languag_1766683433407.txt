Crystal clear â€” and thank you for tightening that language, because this distinction **matters**.

### âœ… Branch / workspace alignment (now officially locked)

Letâ€™s restate it cleanly so there is **zero ambiguity** for anyone touching this system:

* **Main branch = Development source of truth**

  * This is where *all* fixes, migrations, stability work, and architecture changes happen.
* **Staging branch**

  * Receives promoted code from main.
  * Used for verification, health checks, fallback-rate checks.
* **Production branch**

  * Receives promoted code from staging.
  * Powers the deployed web app and iOS TestFlight / App Store builds.

When we say â€œdev workspace,â€ we mean:

> **Main branch only â€” not a side dev copy of production.**

That is now aligned across everyone. ğŸ‘

---

## âœ… Final confirmation on the 7 rules

I explicitly approve **all 7 confirmations** exactly as you stated them:

1. **YES** â€“ All work happens in main first
2. **YES** â€“ `shared/schema.ts` is the single migration truth
3. **YES** â€“ Missing required tables â†’ **503**, never silent fallback
4. **YES** â€“ All responses tagged with `generationSource`
5. **YES** â€“ `/api/health/ai` exposes real behavior (success/fallback/error)
6. **YES** â€“ Staging & prod migrations are explicitly handled
7. **YES** â€“ TestFlight is blocked by schema or fallback violations

These are now **non-negotiable platform rules**.

---

## âœ… Decision on migration automation (Step 6)

I **approve Option A: Prestart hook**
ğŸ‘‰ *Add `db:push` (or equivalent) to the app start lifecycle.*

### Why Option A is the correct choice here

Given Replitâ€™s deployment model:

* CI/CD gates (Option C) are overkill *right now*
* Manual checklists (Option B) are how bugs come back later
* **Prestart hook guarantees schema parity automatically**

This gives you:

* Zero â€œsomeone forgot to run migrationsâ€
* Identical behavior in staging and production
* Deterministic startup guarantees

### One important constraint (Facebook-level detail)

The prestart migration must be:

* **Idempotent**
* **Non-destructive**
* **Safe to run multiple times**

Drizzleâ€™s `db:push` fits that requirement **as long as schema is correct** (which it now will be).

---

## ğŸ§± Final state we are agreeing to

From this point forward:

* If code references a table â†’ it **must** be in `shared/schema.ts`
* If a table is missing â†’ the app **tells the truth and refuses**
* If AI doesnâ€™t run â†’ the response **says so**
* If fallbacks spike â†’ TestFlight is **blocked**
* If staging isnâ€™t healthy â†’ production **never updates**
* If production isnâ€™t healthy â†’ iOS **never ships**

That is **Facebook-level stability**, scaled appropriately for MPM.

---

## ğŸš¦ Green light

You have my full approval on:

* the 7 confirmations
* Option A for migration automation
* proceeding in the **main (development) branch**

ğŸ‘‰ **Yes â€” proceed.**

Have the architect:

1. Create the task list
2. Implement in main
3. Report back with:

   * migration verification
   * startup validation behavior
   * sample health endpoint output

When that comes back, weâ€™ll do a final **release-readiness audit** before anything touches staging, production, or TestFlight.

This is the turning point. Youâ€™re finally building on bedrock.
