Got it. I’m going to be **painfully specific about WHERE** each step happens (Replit vs Mac), and I’ll keep this in a clean sequence you can follow without guesswork.

---

# 1) Publish the PRODUCTION Replit and grab the stable URL

## 1A — In **Replit (Production project)**

1. Open your **Production** Replit project.
2. Click **Deployments** (rocket icon) in the left sidebar.
3. Choose **Autoscale** (or whatever your production deployment type is) → click **Deploy**.

## 1B — Confirm deploy succeeded (still in **Replit**)

1. Wait until the deployment status shows **Running / Healthy**.
2. Replit will show a public URL that ends in:

   * `https://<something>.replit.app`
3. Click **Open** on that URL.

## 1C — Confirm health endpoint (still in **Replit browser tab**)

Open this in your browser:

* `https://YOUR_DOMAIN.replit.app/api/health`

You should see something like OK/healthy (whatever your endpoint returns).
**Copy the exact domain** (everything up to `.replit.app`, no path).

✅ Your production domain is now known. Example (fake):

* `https://my-perfect-meals-clean-ai.replit.app`

---

# 2) Update code/config to use the production URL

You’re updating two categories:

* **Client API resolution** (what the web app calls)
* **Capacitor server url** (what the native wrapper loads)

## 2A — Set PROD_SERVER_URL in `resolveApiBase.ts`

### Where: **Replit (Production project)** *or* **Mac repo**, whichever is your source of truth

File:

* `client/src/lib/resolveApiBase.ts`

Set:

* `PROD_SERVER_URL = "https://YOUR_DOMAIN.replit.app"`

### Trailing slash rule

* **Do NOT** include a trailing slash unless the code explicitly expects it.
* Best practice: store base as **no trailing slash**:

  * ✅ `https://x.replit.app`
  * ❌ `https://x.replit.app/`
    Then your code can safely do `${base}/api/...`.

If your file currently concatenates paths badly, fix it by normalizing once (I’ll show that in section 4).

---

## 2B — Update `capacitor.config.ts` to point iOS at the remote web

### Where: **Mac repo** (recommended), because the actual iOS wrapper lives on your Mac/Xcode

File:

* `capacitor.config.ts`

Set this **server block**:

```ts
server: {
  url: "https://YOUR_DOMAIN.replit.app",
  cleartext: false,
  androidScheme: "https",
  iosScheme: "https",
}
```

### Important note

If you set `server.url`, Capacitor will load the **remote hosted web app** in WKWebView (not the bundled `client/dist`). That’s what you asked for.

---

## 2C — Environment files (`.env.production`) only if your code uses them

### Where: **Replit + Mac**, depending on where `.env.production` exists

Check for these files:

* `client/.env.production`
* `.env.production`
* `client/.env`

If you see anything like:

* `VITE_API_BASE_URL=...`
* `VITE_PROD_SERVER_URL=...`

Make it match the same production domain:

* `https://YOUR_DOMAIN.replit.app`

If you *don’t* have these env vars, skip this. Don’t invent new config unless we decide to in section 4.

---

## 2D — Build + Sync timing (what runs where)

### If you are using **remote server.url** for iOS

You still need to sync iOS so the native project picks up the new config.

#### Where: **Mac**

From repo root:

```bash
npm install
npx cap sync ios
```

### When to run `npm run build:client`

* If you are loading **remote** (`server.url` set): build isn’t required for the iOS wrapper to *load*, but it’s still useful for sanity and for non-remote scenarios.
* If you are bundling locally (no server.url): you must build and copy into native.

So for your current goal (remote):

* **Minimum**: `npx cap sync ios`
* Optional sanity: `npm run build:client`

---

# 3) iOS native checks: ATS + verify WKWebView loads production

## 3A — Confirm ATS is fine (usually no changes needed)

### Where: **Mac / Xcode**

File:

* `ios/App/App/Info.plist`

Replit domains are HTTPS with valid certs, so **ATS should allow it by default**.

You only add ATS exceptions if:

* you are loading **http** (you are not)
* you have a weird redirect to non-https (rare)
* you are calling an insecure third-party endpoint

So first try **with no ATS changes**.

### If you MUST add an exception (only if you see ATS errors)

In `Info.plist`, you’d add:

* `NSAppTransportSecurity`

  * `NSExceptionDomains`

    * `YOUR_DOMAIN.replit.app`

      * `NSIncludesSubdomains` = YES
      * `NSTemporaryExceptionAllowsInsecureHTTPLoads` = NO

But again: **don’t add this unless you see an ATS failure in logs.**

---

## 3B — Verify WKWebView loads the production app

### Where: **Mac / Xcode**

1. Open:

   * `ios/App/App.xcworkspace` (NOT `.xcodeproj`)
2. Select a simulator/device.
3. Build + Run.

### What success looks like

* App launches
* You see your production UI
* Network requests hit:

  * `https://YOUR_DOMAIN.replit.app/api/...`

### If it loads blank

Check:

* Xcode console logs for “App Transport Security…” errors
* Or the app is loading but API calls are failing (CORS / allowlist)

---

# 4) API base URL switching best practices (and how to confirm production is chosen)

## 4A — How to confirm what `resolveApiBase.ts` returns under Capacitor

### Where: **Mac repo**

Open:

* `client/src/lib/resolveApiBase.ts`

You’re usually detecting Capacitor via something like:

* `Capacitor.isNativePlatform()`
* `window.Capacitor`
* `import { Capacitor } from '@capacitor/core'`

**Add a temporary log** (seriously helpful):

```ts
console.log("[resolveApiBase] isNative:", /* your native check */);
console.log("[resolveApiBase] base:", baseUrlYouReturn);
```

Then run from Xcode and check console output.

✅ If it prints the `https://YOUR_DOMAIN.replit.app` base, you’re good.

---

## 4B — Recommended improvement: add `VITE_API_BASE_URL` override

This keeps dev/staging logic intact while allowing explicit overrides.

### Where: **client/src/lib/resolveApiBase.ts**

At the top of your resolver, do:

```ts
const override = import.meta.env.VITE_API_BASE_URL;
if (override) return override.replace(/\/$/, "");
```

Then:

* Dev Replit can set `VITE_API_BASE_URL` to dev domain if needed
* Staging Replit sets it to staging domain
* Production sets it to production domain
* Your “native detection” becomes less fragile

This is optional, but it’s cleaner long-term.

---

# 5) CORS + security (server allowlist must include production domain)

If your iOS app is loading the **remote** site, your API calls typically originate from that same domain. Still, CORS matters if you have multiple origins (or if your API host differs).

## 5A — Find the CORS config

### Where: **Replit Production project** (or your repo)

Common places:

* `server/middleware/cors.ts`
* `server/index.ts`
* `server/app.ts`
* `server/middleware/security.ts`

Look for:

* `cors({ origin: ... })`
* allowlist arrays like `allowedOrigins = [...]`

## 5B — Add production domain to allowlist

Add:

* `https://YOUR_DOMAIN.replit.app`

Example allowlist pattern:

```ts
const allowedOrigins = [
  "https://YOUR_DOMAIN.replit.app",
  "https://YOUR_STAGING_DOMAIN.replit.app",
  "https://YOUR_DEV_DOMAIN.replit.app",
];
```

Also consider allowing Capacitor origins if you ever switch away from `server.url`:

* `capacitor://localhost`
* `http://localhost` (sometimes used internally)

But don’t loosen this unless needed.

---

## 5C — HTTPS + ATS notes for Replit

* Replit `.replit.app` domains are HTTPS with valid certs.
* ATS is usually fine.
* The bigger problem tends to be **CORS allowlist** and **API base mismatch**, not TLS.

---

# Quick validation checklist

## Replit Deployment

* [ ] Production deployment shows **Healthy/Running**
* [ ] `https://YOUR_DOMAIN.replit.app/api/health` returns OK
* [ ] App loads at `https://YOUR_DOMAIN.replit.app`

## Code/Config

* [ ] `PROD_SERVER_URL` set to `https://YOUR_DOMAIN.replit.app` (no trailing slash)
* [ ] `capacitor.config.ts` has `server.url = https://YOUR_DOMAIN.replit.app`
* [ ] CORS allowlist includes `https://YOUR_DOMAIN.replit.app`

## Capacitor + iOS

* [ ] On Mac: `npx cap sync ios` completed without errors
* [ ] Xcode run loads UI and makes successful API calls
* [ ] No ATS errors in Xcode console

---

## One thing I need from you (so we don’t waste another hour)

Paste the **exact production public URL** you copied from Replit (just the domain), and I’ll tell you **exactly** what to paste into:

* `resolveApiBase.ts`
* `capacitor.config.ts`
* the CORS allowlist

No guessing, no “maybe.”
