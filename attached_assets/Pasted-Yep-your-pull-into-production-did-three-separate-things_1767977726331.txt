Yep — your “pull into production” did **three separate things**, and you got **three separate failures** mixed together. Here’s exactly what happened and what to do.

---

## 1) ✅ The build failed for the real reason: Vite can’t resolve `@capacitor/app-launcher`

This line is the root cause:

> Rollup failed to resolve import "@capacitor/app-launcher" from client/src/lib/platform.ts

That means: **your web build is trying to bundle an iOS-only Capacitor plugin** and Vite can’t find it (or it isn’t installed in this workspace’s node_modules).

### Why this is happening

You likely installed `@capacitor/app-launcher` in a different environment (your Mac/Xcode project) or only in the iOS project — but **your production workspace (Replit) doesn’t have it installed**, and/or your code is doing a **static import** somewhere that Rollup must resolve at build time.

Even if you *think* it’s “dynamic”, this error says Vite is still seeing an import it must resolve.

### What to do (production-safe fix)

You have two good options:

#### ✅ Option A (Best): Use `@capacitor/app` instead (no extra plugin)

Capacitor already has `App.openUrl()` in `@capacitor/app`. No app-launcher needed.

**In iOS**: open the subscriptions URL with `App.openUrl({ url })`.

**In web**: use `window.open(url, "_blank")`.

This keeps builds clean because `@capacitor/app` is usually already present.

#### ✅ Option B: Keep app-launcher but make it *truly* dynamic + installed

* Ensure `@capacitor/app-launcher` is in **workspace package.json** dependencies (not just ios)
* Ensure platform.ts never imports it statically

**In other words**: no `import { AppLauncher } from "@capacitor/app-launcher"` at the top. Ever.

---

## 2) `npm run start` ran anyway because your shell didn’t stop on build error

You did:

```
npm run build
npm run start
```

Even though build failed, you still ran start. So the server tried to launch using **whatever already existed** from the last successful build (old `client/dist`, old `dist/prod.js`), which is why it “started” at all.

That’s why you saw it serving:

> Serving static files from: /client/dist

But that build output is not guaranteed to match your latest code.

---

## 3) Your server crashed because port 5000 is already in use (EADDRINUSE)

This is separate from the Vite error.

> listen EADDRINUSE: address already in use 0.0.0.0:5000

Meaning: **something is already running on port 5000** in that environment.

### Common causes in your setup

* You already have a running “production” process
* Replit already runs one server instance automatically
* A previous `npm run start` didn’t fully stop
* Another process is bound to 5000

### Fix it

* Stop the existing process (in Replit: stop the running web app / restart the repl)
* Or change your server port to use Replit’s provided port (usually `process.env.PORT`)

**Your server must do:**

```js
const port = process.env.PORT || 5000;
```

If it’s hardcoded to 5000 anywhere, that’s asking for EADDRINUSE.

---

## 4) Bonus red flag: Your server thinks it’s in DEVELOPMENT while you started production

You ran:

> `NODE_ENV=production node dist/prod.js`

But logs show:

> `[DB] Environment: DEVELOPMENT`

That means your code is using something like `process.env.ENVIRONMENT` or a custom flag, not NODE_ENV, or it defaults wrong.

This matters because:

* It can point prod server at dev DB
* It can turn on dev-only features (including payment routing)

You need to verify the env check logic in your DB config.

---

# ✅ What I would do right now (the clean “production pull” sequence)

### Step A — Fix the Capacitor dependency issue (do this first)

Either:

* Replace app-launcher with `@capacitor/app` (preferred), OR
* Install app-launcher in the workspace and remove all static imports.

### Step B — Rebuild and ensure it succeeds

Run:

* `npm ci` (or `npm install`)
* `npm run build`
  No start until build passes.

### Step C — Fix port binding

Make sure server uses:

* `process.env.PORT || 5000`

### Step D — Confirm correct environment

Make sure your server + DB use a single “source of truth” for env:

* NODE_ENV=production
* and your custom ENV var if you have one (`APP_ENV=production`, etc.)

---

## The blunt truth

You’re not “pulling into production” yet — you’re **starting a server with an old build**, while the new build fails, and you’ve got a port conflict.

Fix the Capacitor import + port handling, and you’re solid.

If you paste your `client/src/lib/platform.ts` (the part importing app-launcher) and the code where you set the server port, I’ll tell you exactly what to change (no guessing, no fluff).
