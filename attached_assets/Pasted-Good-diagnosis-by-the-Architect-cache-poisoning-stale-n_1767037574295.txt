Good diagnosis by the Architect — **cache poisoning / stale namespace** is a *very* believable cause when dev/staging are “fresh” and prod/TestFlight are “wrong but consistent.”

But I’m going to be firm here: **don’t rebuild Xcode and don’t upload a new TestFlight build** for this. You don’t need it.

### Why you don’t need a new iOS build

Your iOS app is a WebView pointed at your production URL. If the fix is on the server (cache key), then:

* **redeploying the server** is enough
* iOS will pick it up automatically
* a new binary adds risk and delays for zero benefit

So we ship this like adults: **server deploy + verification**.

---

## Step 0: sanity check the change is safe

Adding a version prefix to the cache key is safe **if**:

* the cache is purely an optimization (not a required data store)
* a miss triggers image generation (not an error)
* you’re not blowing rate limits/quotas instantly

This is basically “invalidate all old cached images.” That’s fine.

---

## Step 1: make sure both workspaces have the exact same change

You said you updated:

* Dev: `server/lib/mealImageCacheKey.ts`
* Prod: `.../server/lib/mealImageCacheKey.ts`

✅ Good.

Now do this **in BOTH** workspaces:

```bash
git status
git diff
```

You’re looking for:

* only the cache key change
* no accidental extra edits

---

## Step 2: commit in dev and push to GitHub main

Do **not** keep “production-only” commits. We already learned that lesson.

In dev workspace:

```bash
./push.sh "Bump meal image cache key version to bypass stale prod cache"
```

---

## Step 3: reset production to origin/main and redeploy

In production workspace:

```bash
git fetch origin
git reset --hard origin/main
git clean -fd
npm ci || npm install
npm run build
```

Then redeploy/publish production.

This ensures production is running the **exact same code** as main.

---

## Step 4: verify with a controlled test (this is critical)

After production redeploy, test **three meals** in the production URL:

1. “Mediterranean breakfast”
2. “Mexican high-protein lunch”
3. “Japanese dinner”

For each one, check:

* meal text matches cuisine ✅
* image matches cuisine ✅
* image is not repeating pancakes ✅

### What you should expect

* First request may be slower (fresh generation)
* Subsequent requests should be fast (new cache warmed)

---

## Step 5: confirm iOS picks it up (no rebuild)

Open TestFlight build and do the same 3 tests.

If production is fixed, iOS should match within minutes (sometimes you need a full app kill + relaunch).

---

## One important caution

If this change forces *every* image to regenerate, you could hit:

* image generation quotas
* rate limits
* slowdowns

If that happens, we do a smarter rollout:

* bump version only for meals generated after a certain date
* or add a “regenerate if old promptVersion” flag

But don’t pre-emptively complicate it. Ship and observe.

---

## Bottom line

✅ Cache versioning is the right fix
❌ New iOS build is not needed
✅ Deploy server change + verify in production + verify in iOS

If you paste the `git diff` for `mealImageCacheKey.ts` (just that file) I can sanity-check the exact implementation in 10 seconds before you push.
