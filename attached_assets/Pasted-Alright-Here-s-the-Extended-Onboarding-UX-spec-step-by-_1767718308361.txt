Alright. Here’s the **Extended Onboarding UX spec** step-by-step, designed to do one job: **initialize context** (Builder + Macros + Starch Plan) so users don’t land in the planner “undefined.”

This is written so you can hand it to your agent/dev and build it without re-litigating decisions.

---

# Extended Onboarding UX Spec

## Core Principles

* **One outcome:** user enters app with a complete `UserContext`.
* **No decision fatigue:** one builder, one starch strategy, sane macro defaults.
* **Fast path:** 2–4 minutes.
* **Refine later:** everything can be edited later (except ProCare clients).

---

# Entry Points

### A) New paid user (normal)

* Trigger: After signup + successful subscription (or tier selection during testing)
* Route: `/onboarding/extended`

### B) Existing user missing context (failsafe)

* Trigger: login detects missing `macrosDefined` or `starchPlanDefined` or `activeBuilderKey`
* Route: `/onboarding/extended?repair=1`
* Copy: “Let’s finish your setup so your meals match your goals.”

### C) ProCare client

* Trigger: context mode = procare
* Behavior: onboarding becomes **coach-managed**:

  * builder locked (assigned)
  * macros/starch can be coach-defined or client-confirmed (depending on your policy)

---

# Global UI Rules (All Steps)

* Top progress indicator: **Step X of 4**
* Back button allowed except on final confirmation
* “Save & continue” persists each step
* “Skip” only allowed where safe (with defaults applied)
* If user exits: resume where they left off

---

# Step 1 — Goal & Builder Education (Route: `/onboarding/goals`)

### Purpose

Explain builders in human terms and reduce wrong picks.

### UI

* Title: **“What are you focused on right now?”**
* Subtitle: “This sets your primary meal builder. You can change it later.”

### Cards (tap to continue)

* **General Lifestyle** (default)
* **Diabetes / Blood Sugar**
* **GLP-1 / Appetite Support**
* **Performance / Athlete**
* **Weight Loss (simple)** *(optional if you map it to General)*

Each card includes:

* 1-line promise
* “Best for…” bullets (2–3)
* “You’ll get…” bullets (2–3)

### Decision

* When user selects, store:

  * `selectedBuilderKey`
  * `builderReason` (optional analytics)

### Primary CTA

* **Continue**

### Edge Case Handling

* If user taps “Diabetes/Blood Sugar” but you don’t want medical heaviness:

  * show micro-warning: “This builder uses more strict carb guidance.”

---

# Step 2 — Choose Primary Builder (Route: `/onboarding/select-builder`)

### Purpose

Hard selection and expectation setting: **one builder**.

### UI

* Title: **“Choose your Primary Builder”**
* Subtitle: “This is the only builder you’ll be able to open in Planner. You can switch later from Settings.”

### Layout

* Show only the top 2–3 builders based on Step 1 selection.

  * Example: If “Diabetes” chosen:

    * Diabetes Builder (recommended)
    * General Builder (less strict)
* Each has:

  * “Recommended” badge (one only)
  * “Strictness” meter (Low / Medium / High)
  * “What changes” bullets

### Confirmation Microcopy (important)

When user selects:

* “Primary Builder set to: Diabetes Builder”
* “You can switch later using Select Builder.”

### Primary CTA

* **Set Primary Builder**

### Rule

On submit:

* `activeBuilderKey = selectedBuilderKey`
* `mode = independent` (unless procare)

---

# Step 3 — Macro Setup (Simplified Macro Calculator) (Route: `/onboarding/macros`)

### Purpose

Define targets so the planner has fuel to work with.

### UI

* Title: **“Set your daily targets”**
* Subtitle: “We’ll use this to build meals that fit your goals.”

### Option A: Fast Setup (recommended default)

Two buttons at top:

* **Fast Setup (Recommended)**
* **Custom**

**Fast Setup fields:**

* Sex (optional if already in profile)
* Age
* Height
* Weight
* Activity level (4 choices)
* Goal (Lose / Maintain / Gain)

Then show results:

* Calories
* Protein
* Carbs
* Fat

Include small “edit” icon beside each macro so they can tweak without going “Custom.”

**CTA:** **Save Targets**

### Option B: Custom

* Manual sliders or input boxes for macros
* Keep it simple, not clinical

### Required Output (must be stored)

* caloriesTarget
* proteinTarget
* carbTarget
* fatTarget

### Citations Access

Since Apple already flagged this:

* include the **MedicalSourcesInfo** icon here too (same as macro calculator)

### Guardrails (light)

* If protein absurdly low/high, show warning and suggest range
* Never block, just warn

---

# Step 4 — Starch Game Plan (Route: `/onboarding/starch-strategy`)

### Purpose

This is your “behavior doctrine” piece. It makes the builder predictable.

### UI

* Title: **“Pick your Starch Game Plan”**
* Subtitle: “This controls how carbs are distributed across your day.”

### Two options (cards)

1. **One Starch Meal**

* “One main meal includes starch; the rest are lower-starch.”
* Best for: appetite control, blood sugar, cutting

2. **Flex Split**

* “Starch can be split across meals to support performance and energy.”
* Best for: athletes, high activity, maintenance

### Default Recommendations

* If Diabetes builder: recommend **One Starch Meal**
* If Performance: recommend **Flex Split**
* If General: pick based on goal (lose → one starch, maintain/gain → flex)

### CTA

* **Continue**

### Store

* `starchStrategy = "one_starch_meal" | "flex_split"`
* `starchPlanDefined = true`

---

# Step 5 — Setup Confirmation + Enter App (Route: `/onboarding/finish`)

### Purpose

Make it feel official. Reduce churn. Confirm the lock.

### UI Summary Card

* Primary Builder: **X**
* Targets: **Calories / P / C / F**
* Starch Plan: **X**

### Buttons

* **Enter Planner**
* Secondary: “Edit” next to each line (go back to step)

### On Enter

Backend sets:

* `macrosDefined = true`
* `starchPlanDefined = true`
* `onboardingCompleted = true`

Then route:

* `/planner`

---

# Planner Behavior After Onboarding (Required)

On Planner screen:

* Show all builders as tiles
* Only `activeBuilderKey` tile is clickable
* Others show lock + explanation:

  * “Available when you switch your primary builder”
  * OR “Included in Pro tier” (if tier-gated)

---

# ProCare Integration Rules (So It Doesn’t Break Later)

If `mode = procare`:

* Step 2 (builder choice) is replaced with:

  * “Your coach has assigned your builder: X”
* Macro step:

  * either “Coach preset applied” + allow confirm
* Starch step:

  * either coach preset or client confirm
* Planner:

  * only coach-assigned builder is clickable
  * switching is disabled

---

# Guest → Signup Transition Rule

When guest taps “Create Account / Subscribe”:

* do **not** migrate guest meals
* show one line:

  * “Now let’s set up your plan so meals match your goals.”

---

# Completion Definition (Hard)

Extended onboarding is complete only when:

* activeBuilderKey exists
* macros exist
* starchStrategy exists
* mode set (independent/procare)

If any are missing on login:

* redirect to `/onboarding/extended?repair=1`

---

## If you want the fastest implementation order (no code)

1. Add `UserContext` shape + persisted flags
2. Build Step 2 + Planner lock behavior (visible impact)
3. Add Macro step
4. Add Starch step
5. Add finish screen
6. Add repair redirect

---

If you paste your current onboarding routes (or just list them), I can map this spec onto your exact routing structure and tell you precisely which pages to add, which ones to merge, and where to redirect so you don’t create another “blank screen” situation.
